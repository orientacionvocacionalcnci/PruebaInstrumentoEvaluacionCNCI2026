<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n de Desempe√±o - CNCI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="https://raw.githubusercontent.com/RolandoCalvillo/AppEvaluacionSE/main/favicon.ico" type="image/x-icon">
    <style>
        /* Estilos personalizados para la aplicaci√≥n */
        .gradient-bg {
            background: linear-gradient(135deg, #2a6aff 0%, #ff8500 100%);
        }
        .login-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .input-focus:focus {
            box-shadow: 0 0 0 3px rgba(42, 106, 255, 0.2);
        }
        .btn-primary {
            background-color: #2a6aff;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            background-color: #1a5bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn-secondary {
            background-color: #ff8500;
             transition: all 0.3s ease;
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-secondary:hover {
            background-color: #f07d00;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }


        /* Estilos para la barra de progreso */
        .progress-bar-container { background-color: #e9ecef; border-radius: 9999px; }
        .progress-bar {
            background: linear-gradient(90deg, #2a6aff, #5a8dff);
            transition: width 0.5s ease-in-out;
            border-radius: 9999px;
        }
         .progress-bar-orange {
            background: linear-gradient(90deg, #ff8500, #ffac5c);
            transition: width 0.5s ease-in-out;
            border-radius: 9999px;
        }
        
        /* Estilos para el c√≠rculo de puntaje */
        .score-circle {
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }
        .score-circle:hover {
            transform: scale(1.1);
        }
        .score-high { background-color: #10b981; } /* Verde */
        .score-medium { background-color: #f59e0b; } /* Amarillo */
        .score-low { background-color: #ef4444; } /* Rojo */

        /* Para el icono de desplegar/colapsar */
        .criteria-toggle { transition: transform 0.3s ease; }
        .rotated { transform: rotate(180deg); }

        /* NUEVO: Transici√≥n suave para el contenedor de criterios */
        .criteria-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, margin-top 0.5s ease-in-out;
        }
        .criteria-content.open {
            max-height: 500px; /* Suficientemente grande */
            margin-top: 1rem;
        }


        /* Estilos del SKELETON LOADER para una mejor UX */
        .skeleton {
            background-color: #e2e8f0;
            border-radius: 0.5rem;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }

        /* Ocultar scrollbar en el contenedor de modales */
        .modal-container::-webkit-scrollbar { display: none; }
        .modal-container { -ms-overflow-style: none; scrollbar-width: none; }

        /* Estilos para la tabla interactiva */
        .th-sortable {
            cursor: pointer;
            user-select: none;
        }
        .th-sortable:hover {
            background-color: #f0f4f8;
        }
        
        /* NUEVO: Hover para filas de tabla */
        #asesoresTableBody tr:hover, #supervisorBadgesTableBody tr:hover {
            background-color: #eff6ff; /* bg-blue-50 */
        }
        #usersTableBody tr:hover {
             background-color: #f7fafc; /* bg-gray-50 */
        }
        /* ================= ESTILOS DRAG AND DROP ================= */
        /* El elemento que se arrastra */
        .draggable-criterion {
            cursor: move; /* Cambia el cursor a la manita de mover */
            transition: all 0.2s ease;
        }
        
        /* Efecto visual mientras lo arrastras (se pone semitransparente) */
        .draggable-criterion.dragging {
            opacity: 0.5;
            background-color: #eff6ff; /* Azul muy claro */
            border: 1px dashed #6366f1; /* Borde punteado √≠ndigo */
        }
        
        /* La zona de destino (el grupo) cuando le pasas un elemento por encima */
        .criteria-list.drag-over {
            background-color: #f0fdf4; /* Verde muy claro */
            border: 2px dashed #22c55e; /* Borde verde */
            min-height: 50px; /* Asegura espacio para soltar aunque est√© vac√≠o */
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Contenedor Principal de la App -->
    <div id="app" class="h-screen w-screen">

        <!-- Pantalla de Carga Inicial -->
        <div id="loadingScreen" class="w-full h-full flex flex-col items-center justify-center gradient-bg">
             <img src="https://raw.githubusercontent.com/RolandoCalvillo/AppEvaluacionSE/main/assets/CNCI-VIRTUAL-LOGO.jpg" alt="Logo CNCI" class="h-24 w-auto mb-4 fade-in">
            <h1 class="text-white text-2xl font-bold mb-2 fade-in" style="animation-delay: 0.2s;">Sistema de Evaluaci√≥n de Desempe√±o</h1>
            <div class="w-16 h-16 border-4 border-t-transparent border-white rounded-full animate-spin mt-4 fade-in" style="animation-delay: 0.4s;"></div>
            <p id="loadingStatus" class="text-white mt-4 text-sm fade-in" style="animation-delay: 0.6s;">Conectando con Firebase...</p>
        </div>

        <!-- Pantalla de Login -->
        <div id="loginScreen" class="w-full h-full items-center justify-center p-4 gradient-bg hidden">
            <div class="w-full max-w-md mx-auto login-card rounded-2xl shadow-2xl p-8 border border-white/20 fade-in">
                <div class="text-center mb-6">
                    <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="Logo CNCI" class="mx-auto h-20 w-auto mb-4">
                    <h1 id="loginTitle" class="text-2xl font-bold text-gray-800">Evaluaci√≥n Modular</h1>
                    <p id="loginSubtitle" class="text-gray-600 mt-1">Consulta tu desempe√±o ingresando tus credenciales.</p>
                </div>
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Usuario</label>
                        <input type="text" id="username" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 input-focus" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                        <input type="password" id="password" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 input-focus" required>
                    </div>
                    <div id="loginError" class="hidden text-red-600 text-sm text-center bg-red-100 p-2 rounded-lg"></div>
                    <button type="submit" id="loginButton" class="w-full btn-primary text-white font-semibold py-3 px-6 rounded-lg focus:outline-none flex items-center justify-center">
                        <span id="loginButtonText">Ingresar</span>
                        <div id="loginSpinner" class="hidden w-5 h-5 border-2 border-t-transparent border-white rounded-full animate-spin ml-2"></div>
                    </button>
                </form>
            </div>
        </div>

        <!-- Vista SUPERADMIN -->
        <div id="superAdminScreen" class="hidden h-screen flex flex-col">
            <!-- Header -->
            <header class="bg-white shadow-md p-4 flex justify-between items-center z-10 flex-shrink-0">
                <div class="flex items-center space-x-3">
                    <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="Logo CNCI" class="h-10 w-auto">
                    <h1 class="text-xl font-bold text-gray-800">üëë Panel de Superadministrador</h1>
                </div>
                <div class="flex items-center space-x-4">
                     <div id="superAdminSyncIndicator" class="text-xs text-gray-500 flex items-center space-x-1">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span>Sincronizado</span>
                    </div>
                    <span id="superAdminWelcome" class="text-sm font-medium text-gray-700"></span>
                    <button onclick="logout()" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Salir</button>
                </div>
            </header>
            <!-- Contenido -->
            <main class="flex-grow p-6 overflow-y-auto bg-gray-50">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Columna Izquierda -->
                    <div>
                        <!-- Gesti√≥n de Usuarios -->
                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold">Gesti√≥n de Usuarios</h2>
                                <button onclick="openUserModal()" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">A√±adir Usuario</button>
                            </div>
                            <!-- Barra de B√∫squeda -->
                            <div class="mb-4">
                                <input type="text" id="userSearchInput" placeholder="Buscar por nombre o usuario..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase th-sortable" onclick="sortUsers('nombre')">Nombre ‚ÜïÔ∏è</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase th-sortable" onclick="sortUsers('id')">Usuario ‚ÜïÔ∏è</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase th-sortable" onclick="sortUsers('rol')">Rol ‚ÜïÔ∏è</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase th-sortable" onclick="sortUsers('supervisorAsignado')">Supervisor ‚ÜïÔ∏è</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                             <!-- Paginaci√≥n -->
                            <div id="userPagination" class="mt-4 flex justify-between items-center text-sm"></div>
                        </div>
                         <!-- Anal√≠ticas Globales -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h2 class="text-lg font-bold mb-4">Anal√≠ticas Globales</h2>
                            <div class="flex items-center space-x-4 mb-4">
                                <select id="superAdminMonthSelector" class="rounded-lg border-gray-300 shadow-sm"></select>
                                <select id="superAdminYearSelector" class="rounded-lg border-gray-300 shadow-sm"></select>
                            </div>
                            <div class="relative h-80">
                                <canvas id="superAdminChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- Columna Derecha -->
                    <div class="space-y-6">
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h2 class="text-lg font-bold mb-4">Personalizar Pantalla de Login</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="loginTitleInput" class="block text-sm font-medium text-gray-700">T√≠tulo Principal</label>
                                    <input type="text" id="loginTitleInput" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="loginSubtitleInput" class="block text-sm font-medium text-gray-700">Subt√≠tulo</label>
                                    <input type="text" id="loginSubtitleInput" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="text-right mt-4">
                                <button onclick="saveLoginTitles()" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg">Guardar T√≠tulos</button>
                            </div>
                        </div>
                        <!-- Centro de Respaldo y Restauraci√≥n -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h2 class="text-lg font-bold mb-4">Centro de Datos y Respaldo</h2>
                            <div class="mb-4">
                                <h3 class="font-semibold mb-2">Sincronizaci√≥n Manual con Firebase</h3>
                                <div class="flex space-x-2 mt-1">
                                    <button onclick="forceSyncToFirebase()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Sincronizar a Firebase</button>
                                    <button onclick="forceReloadFromFirebase()" class="flex-1 bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Recargar de Firebase</button>
                                </div>
                            </div>
                            <div class="space-y-4 border-t pt-4">
                                <h3 class="font-semibold">Respaldo CSV</h3>
                                <div>
                                    <h4 class="text-sm font-medium">Usuarios</h4>
                                    <div class="flex space-x-2 mt-1">
                                        <button onclick="exportUsersToCSV()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Exportar</button>
                                        <button onclick="openImportModal('users')" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Importar</button>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-sm font-medium">Insignias</h4>
                                    <div class="flex space-x-2 mt-1">
                                        <button onclick="exportBadgesToCSV()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Exportar</button>
                                        <button onclick="openImportModal('badges')" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Importar</button>
                                    </div>
                                </div>
                                <div class="mt-4 border-t pt-4">
                                    <h4 class="text-sm font-medium">Evaluaciones (Filtros Avanzados)</h4>
                                    <div class="mt-1">
                                        <button onclick="openMassExportModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm flex justify-center items-center shadow transition-colors">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                            Exportar Personalizada
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <!-- Gesti√≥n de Insignias Globales -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold">Gesti√≥n de Insignias Globales</h2>
                                <button onclick="openBadgeModal()" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg">A√±adir Insignia</button>
                            </div>
                             <div class="overflow-x-auto max-h-60">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Icono</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="globalBadgesTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Gesti√≥n de Per√≠odos H√°biles -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h2 class="text-lg font-bold mb-4">Gesti√≥n de Per√≠odos H√°biles</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="availableYearsInput" class="block text-sm font-medium text-gray-700">A√±os Disponibles (separados por coma)</label>
                                    <input type="text" id="availableYearsInput" placeholder="Ej: 2025,2024" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="availableMonthsInput" class="block text-sm font-medium text-gray-700">Meses Disponibles (separados por coma)</label>
                                    <input type="text" id="availableMonthsInput" placeholder="Ej: Enero,Febrero,Marzo..." class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="text-right mt-4">
                                <button onclick="saveAvailablePeriods()" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg">Guardar Per√≠odos</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 border-t border-gray-200 pt-8 pb-12 w-full">
                    <div class="flex flex-col xl:flex-row justify-between items-start xl:items-end mb-8 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                                <span class="text-3xl mr-2">üìä</span> Centro de Resultados
                            </h2>
                            <p class="text-sm text-gray-500 mt-1">An√°lisis de tendencias, distribuci√≥n y descarga de reportes detallados.</p>
                        </div>
                        
                        <div class="flex flex-wrap gap-3 bg-white p-4 rounded-xl shadow-sm border border-gray-100 items-end w-full xl:w-auto">
                            <div>
                                <label class="text-xs font-bold text-gray-400 uppercase ml-1 block mb-1">A√±o</label>
                                <select id="anlYear" class="bg-gray-50 border border-gray-300 text-sm rounded-lg p-2.5 w-full xl:w-24 focus:ring-blue-500 outline-none"></select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-400 uppercase ml-1 block mb-1">Mes</label>
                                <select id="anlMonth" class="bg-gray-50 border border-gray-300 text-sm rounded-lg p-2.5 w-full xl:w-32 focus:ring-blue-500 outline-none">
                                    <option value="all">Todos</option>
                                </select>
                            </div>
                                <div class="relative w-full xl:w-56">
                                    <label class="text-xs font-bold text-gray-400 uppercase ml-1 block mb-1">Supervisores</label>
        
                                    <button onclick="toggleSupDropdown()" id="supDropdownBtn" class="bg-gray-50 border border-gray-300 text-sm rounded-lg p-2.5 w-full text-left flex justify-between items-center focus:ring-blue-500 focus:border-blue-500">
                                        <span id="supBtnText" class="truncate">Todos seleccionados</span>
                                        <svg class="w-4 h-4 ml-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
        
                                    <div id="supDropdownList" class="hidden absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto p-2">
                                        <div class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                            <input type="checkbox" id="sup-check-all" checked onchange="toggleAllSupervisors(this)" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                            <label for="sup-check-all" class="ml-2 text-sm font-bold text-gray-700 cursor-pointer w-full">Seleccionar Todos</label>
                                        </div>
                                        <hr class="my-1 border-gray-100">
                                        <div id="supCheckboxesContainer" class="space-y-1"></div>
                                    </div>
                                </div>
                            <div class="flex gap-2 w-full xl:w-auto">
                                <button onclick="updateAnalytics()" class="flex-1 xl:flex-none bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm shadow transition-all h-[42px] flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                    Analizar
                                </button>
                                <button onclick="downloadWideCSV()" class="flex-1 xl:flex-none bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm shadow transition-all h-[42px] flex items-center justify-center" title="Descargar CSV con desglose de categor√≠as">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    CSV
                                </button>
                            </div>
                        </div>
                    </div>
                
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-5 rounded-xl shadow lg:col-span-2">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center">
                                <span class="bg-blue-100 text-blue-600 p-1 rounded mr-2 text-xs">A</span>
                                Tendencia Mensual (Promedio Global)
                            </h3>
                            <div class="relative h-64">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow lg:col-span-1">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center">
                                <span class="bg-blue-100 text-blue-600 p-1 rounded mr-2 text-xs">B</span>
                                Estatus de Calificaciones
                            </h3>
                            <div class="relative h-64 flex justify-center">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                
                    <div class="bg-white rounded-xl shadow overflow-hidden">
                        <div class="flex border-b bg-gray-50 overflow-x-auto">
                            <button onclick="switchAnaTab('t1')" id="btn-t1" class="ana-tab whitespace-nowrap px-6 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-white focus:outline-none transition-colors">
                                1. Detalle General (CSV)
                            </button>
                            <button onclick="switchAnaTab('t2')" id="btn-t2" class="ana-tab whitespace-nowrap px-6 py-3 text-sm font-bold text-gray-500 hover:text-gray-700 focus:outline-none transition-colors">
                                2. Matriz Anual
                            </button>
                            <button onclick="switchAnaTab('t3')" id="btn-t3" class="ana-tab whitespace-nowrap px-6 py-3 text-sm font-bold text-gray-500 hover:text-gray-700 focus:outline-none transition-colors">
                                3. Comparativa Supervisores
                            </button>
                        </div>
                
                        <div id="view-t1" class="p-0 overflow-x-auto max-h-[500px]">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-100 text-gray-600 sticky top-0 z-10 shadow-sm" id="t1-head">
                                    </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="t1-body"></tbody>
                            </table>
                        </div>
                
                        <div id="view-t2" class="p-0 overflow-x-auto hidden max-h-[500px]">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-100 text-gray-600 sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-bold uppercase sticky left-0 bg-gray-100 border-r z-20">Asesor</th>
                                        <th class="px-2 text-center text-xs">Ene</th><th class="px-2 text-center text-xs">Feb</th>
                                        <th class="px-2 text-center text-xs">Mar</th><th class="px-2 text-center text-xs">Abr</th>
                                        <th class="px-2 text-center text-xs">May</th><th class="px-2 text-center text-xs">Jun</th>
                                        <th class="px-2 text-center text-xs">Jul</th><th class="px-2 text-center text-xs">Ago</th>
                                        <th class="px-2 text-center text-xs">Sep</th><th class="px-2 text-center text-xs">Oct</th>
                                        <th class="px-2 text-center text-xs">Nov</th><th class="px-2 text-center text-xs">Dic</th>
                                        <th class="px-4 text-center font-bold bg-gray-200 border-l">PROM</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="t2-body"></tbody>
                            </table>
                        </div>
                
                        <div id="view-t3" class="p-0 overflow-x-auto hidden max-h-[500px]">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-100 text-gray-600 sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="px-6 py-3 text-left font-bold uppercase cursor-pointer" onclick="sortSimpleTable('t3-body', 0)">Supervisor ‚Üï</th>
                                        <th class="px-6 py-3 text-center font-bold uppercase">Asesores Evaluados</th>
                                        <th class="px-6 py-3 text-center font-bold uppercase cursor-pointer" onclick="sortSimpleTable('t3-body', 2)">Promedio Equipo ‚Üï</th>
                                        <th class="px-6 py-3 text-center font-bold uppercase">Estatus</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="t3-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Vista SUPERVISOR -->
        <div id="supervisorScreen" class="hidden h-screen flex flex-col">
            <!-- Header -->
            <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10 flex-shrink-0 border-b">
                 <div class="flex items-center space-x-3">
                    <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="Logo CNCI" class="h-10 w-auto">
                    <h1 class="text-xl font-bold text-gray-800">üßë‚Äçüè´ Panel de Supervisor</h1>
                </div>
                 <div class="flex items-center space-x-4">
                     <div id="supervisorSyncIndicator" class="text-xs text-gray-500 flex items-center space-x-1">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span>Sincronizado</span>
                    </div>
                    <span id="supervisorWelcome" class="text-sm font-medium text-gray-700"></span>
                    <button onclick="logout()" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Salir</button>
                </div>
            </header>
             <!-- Contenido -->
            <main class="flex-grow p-6 overflow-y-auto bg-slate-50">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Columna de Asesores y Respaldo -->
                    <div class="lg:col-span-1 space-y-6 fade-in-up">
                        <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 border-t-4 border-blue-500">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                     <h2 class="text-lg font-bold text-gray-800">üë• Mis Asesores</h2>
                                     <button onclick="openAddAsesorModal()" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg text-sm">A√±adir Asesor</button>
                                </div>
                                <div class="overflow-x-auto max-h-72">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-slate-100">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="asesoresTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- Centro de Respaldo para Supervisor -->
                        <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 border-t-4 border-orange-500">
                           <div class="p-6">
                             <h2 class="text-lg font-bold mb-4 text-gray-800">üíæ Respaldo de Evaluaciones</h2>
                            <p class="text-sm text-gray-600 mb-4">Exporta o importa las evaluaciones de tus asesores en formato CSV.</p>
                            <div class="flex space-x-4">
                                <button onclick="exportSupervisorEvaluationsToCSV()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105">Exportar</button>
                                <button onclick="openImportModal('evaluations')" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105">Importar</button>
                            </div>
                           </div>
                        </div>
                    </div>
                    <!-- Columna de Plantillas y Anal√≠ticas -->
                    <div class="lg:col-span-2 space-y-6 fade-in-up" style="animation-delay: 0.2s;">
                         <!-- Gesti√≥n de Insignias del Supervisor -->
                        <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 border-t-4 border-blue-500">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-lg font-bold text-gray-800">üéñÔ∏è Gesti√≥n de Mis Insignias</h2>
                                    <button onclick="openBadgeModal(null, false)" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg">A√±adir Insignia</button>
                                </div>
                                <div class="overflow-x-auto max-h-60">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-slate-100">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Icono</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="supervisorBadgesTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 border-t-4 border-orange-500">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                        <h2 class="text-lg font-bold text-gray-800">üìÇ Mis Plantillas</h2>
                                        <p class="text-xs text-gray-500">Selecciona una para editarla</p>
                                    </div>
                                    <button onclick="openTemplateModal()" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg text-sm shadow hover:bg-blue-700 transition-colors">+ Crear Nueva</button>
                                </div>
                                
                                <div id="templatesListContainer" class="space-y-2 max-h-48 overflow-y-auto pr-2 custom-scrollbar mb-6 border-b border-gray-200 pb-4">
                                    <div class="text-center text-gray-400 text-sm py-4">Cargando plantillas...</div>
                                </div>
                        
                                <div id="templateEditorArea">
                                    <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-md font-bold text-gray-700 flex items-center">
                                            üìù Contenido de la Plantilla
                                        </h2>
                                        <div class="flex items-center space-x-3">
                                            <div class="flex items-center space-x-1 bg-gray-100 px-2 py-1 rounded">
                                                <span class="text-xs font-medium text-gray-500">Total:</span>
                                                <span id="totalPonderacion" class="font-bold text-lg text-gray-400">0%</span>
                                            </div>
                                            <button onclick="openCategoryModal()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-lg text-sm shadow transition-colors">
                                                + A√±adir Categor√≠a
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="categoriesContainer" class="space-y-3 min-h-[100px]">
                                       <p class="text-gray-400 text-center py-6 text-sm italic bg-gray-50 rounded border border-dashed border-gray-300">
                                           üëÜ Selecciona una plantilla de la lista de arriba para ver y editar sus categor√≠as.
                                       </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- An√°lisis del Equipo -->
                        <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 border-t-4 border-blue-500">
                            <div class="p-6">
                                <h2 class="text-lg font-bold mb-4 text-gray-800">üìä An√°lisis del Equipo</h2>
                                <div class="flex items-center space-x-4 mb-4">
                                    <select id="supervisorMonthSelector" class="rounded-lg border-gray-300 shadow-sm"></select>
                                    <select id="supervisorYearSelector" class="rounded-lg border-gray-300 shadow-sm"></select>
                                </div>
                                <div class="relative h-80">
                                    <canvas id="supervisorChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Vista ASESOR -->
        <div id="asesorScreen" class="hidden h-screen flex flex-col">
            <!-- Header -->
            <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10 flex-shrink-0 border-b">
                <div class="flex items-center space-x-3">
                    <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="Logo CNCI" class="h-10 w-auto">
                    <h1 class="text-xl font-bold text-gray-800">üë®‚Äçüéì Dashboard de Desempe√±o</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <select id="monthSelector" class="rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                        <select id="yearSelector" class="rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                    </div>
                    <span id="asesorWelcome" class="text-sm font-medium text-gray-700"></span>
                    <button onclick="logout()" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Salir</button>
                </div>
            </header>
             <!-- Contenido -->
            <main id="asesorMainContent" class="flex-grow p-6 overflow-y-auto bg-slate-50">
                <!-- Tabs -->
                <div class="mb-6">
                    <nav class="flex space-x-2 sm:space-x-4 bg-slate-200 rounded-lg p-1" aria-label="Tabs">
                        <button onclick="switchAsesorTab('resumen')" class="asesor-tab flex-1 whitespace-nowrap py-2 px-1 text-center font-medium text-sm rounded-md">Resumen</button>
                        <button onclick="switchAsesorTab('tendencias')" class="asesor-tab flex-1 whitespace-nowrap py-2 px-1 text-center font-medium text-sm rounded-md">Tendencias</button>
                        <button onclick="switchAsesorTab('insignias')" class="asesor-tab flex-1 whitespace-nowrap py-2 px-1 text-center font-medium text-sm rounded-md">Insignias</button>
                        <button onclick="switchAsesorTab('plan')" class="asesor-tab flex-1 whitespace-nowrap py-2 px-1 text-center font-medium text-sm rounded-md">Plan de Trabajo</button>
                    </nav>
                </div>
                
                <!-- Contenedor de Pesta√±as -->
                <div id="asesorTabContent" class="fade-in-up">
                    <!-- Pesta√±a Resumen -->
                    <div id="resumen-tab"></div>
                    <!-- Pesta√±a Tendencias -->
                    <div id="tendencias-tab" class="hidden"></div>
                    <!-- Pesta√±a Insignias -->
                    <div id="insignias-tab" class="hidden"></div>
                    <!-- Pesta√±a Plan de Trabajo -->
                    <div id="plan-tab" class="hidden"></div>
                </div>
            </main>
        </div>

    </div> <!-- Fin del #app -->

    <!-- ======================= MODALES ======================= -->
    
    <!-- Modal para A√±adir/Editar Usuario (SuperAdmin) -->
    <div id="userModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h3 id="userModalTitle" class="text-xl font-bold mb-4">A√±adir Usuario</h3>
            <form id="userForm" class="space-y-4">
                <input type="hidden" id="userId">
                <div>
                    <label class="block text-sm font-medium">Nombre Completo</label>
                    <input type="text" id="userFullName" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Nombre de Usuario</label>
                    <input type="text" id="userUsername" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Contrase√±a</label>
                    <input type="text" id="userPassword" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Rol</label>
                    <select id="userRole" class="mt-1 w-full border border-gray-300 rounded-lg p-2">
                        <option value="asesor">Asesor</option>
                        <option value="supervisor">Supervisor</option>
                    </select>
                </div>
                <div id="supervisorSelectorContainer">
                    <label class="block text-sm font-medium">Asignar a Supervisor</label>
                    <select id="userSupervisor" class="mt-1 w-full border border-gray-300 rounded-lg p-2"></select>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeUserModal()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Guardar</button>
                    <button type="button" id="deleteUserBtn" onclick="deleteUser()" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hidden">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: A√±adir Asesor (Supervisor) -->
    <div id="addAsesorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h3 class="text-xl font-bold mb-4">A√±adir Nuevo Asesor</h3>
            <form id="addAsesorForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">Nombre Completo</label>
                    <input type="text" id="asesorFullName" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Nombre de Usuario</label>
                    <input type="text" id="asesorUsername" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Contrase√±a Inicial</label>
                    <input type="text" id="asesorPassword" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeAddAsesorModal()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Crear Asesor</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para A√±adir/Editar Categor√≠a (Supervisor) -->
    <div id="categoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-container">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col"> <div class="p-6 border-b">
                <h3 id="categoryModalTitle" class="text-xl font-bold">Gesti√≥n de Categor√≠a</h3>
            </div>
            
            <div class="p-6 overflow-y-auto flex-grow">
                <form id="categoryForm" class="space-y-6">
                    <input type="hidden" id="categoryId">
                    
                    <div class="grid grid-cols-3 gap-4 p-4 bg-blue-50 rounded-lg border border-blue-100">
                        <div class="col-span-2">
                            <label class="block text-sm font-bold text-blue-800">Nombre de la Categor√≠a</label>
                            <input type="text" id="categoryName" placeholder="Ej. Calidad" class="mt-1 w-full border border-blue-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-blue-800">Ponderaci√≥n (%)</label>
                            <input type="number" id="categoryPonderacion" min="0" max="100" placeholder="0-100" class="mt-1 w-full border border-blue-200 rounded-lg p-2 text-center font-bold text-blue-800" required>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-md font-bold text-gray-700">Grupos de Criterios</h4>
                            <button type="button" onclick="addGroupBlock()" class="text-sm bg-green-100 text-green-700 py-1 px-3 rounded hover:bg-green-200 font-semibold">+ A√±adir Grupo</button>
                        </div>
                        <div id="groupsContainer" class="space-y-4">
                            </div>
                    </div>
                </form>
            </div>

            <div class="p-6 border-t flex justify-end space-x-3 bg-gray-50 rounded-b-lg">
                <button type="button" onclick="closeCategoryModal()" class="bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-50">Cancelar</button>
                <button type="button" onclick="submitCategoryForm()" class="btn-primary text-white font-semibold py-2 px-6 rounded-lg shadow-md">Guardar Categor√≠a</button>
            </div>
        </div>
    </div>

    <!-- Modal de Evaluaci√≥n (Supervisor) -->
    <div id="evaluationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-container">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                 <h3 id="evaluationModalTitle" class="text-xl font-bold">Evaluando a...</h3>
                 <button onclick="closeEvaluationModal()" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <form id="evaluationForm" class="space-y-6">
                    <input type="hidden" id="evaluationAsesorId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                       <div>
                            <label class="block text-sm font-medium">Mes</label>
                            <select id="evaluationMonth" class="mt-1 w-full border border-gray-300 rounded-lg p-2"></select>
                       </div>
                       <div>
                            <label class="block text-sm font-medium">A√±o</label>
                            <select id="evaluationYear" class="mt-1 w-full border border-gray-300 rounded-lg p-2"></select>
                       </div>
                    </div>
                    <!-- Bot√≥n para otorgar insignias -->
                    <div class="text-center">
                        <button type="button" onclick="openGrantBadgeModal()" class="btn-secondary text-white font-semibold py-2 px-6 rounded-lg">üèÜ Otorgar Insignias</button>
                    </div>
                    <!-- Selector de plantillas -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
                        <label class="block text-xs font-bold text-blue-800 uppercase mb-1">Plantilla a Utilizar *</label>
                        <select id="evaluationTemplateSelector" onchange="handleTemplateChange()" class="w-full border-blue-300 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 text-gray-700 font-medium bg-white">
                            <option value="" disabled selected>-- Selecciona una plantilla --</option>
                            </select>
                        <p id="templateChangeWarning" class="hidden text-xs text-red-500 mt-1 font-bold">‚ö†Ô∏è Cambiar la plantilla borrar√° los puntajes actuales.</p>
                    </div>
                    <!-- Contenedor para las categor√≠as a evaluar -->
                    <div id="evaluationCategoriesContainer" class="space-y-4"></div>
                </form>
            </div>
            <div class="p-6 border-t flex justify-end space-x-3 bg-gray-50 rounded-b-lg">
                <button type="button" onclick="closeEvaluationModal()" class="bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-50">Cancelar</button>
                
                <button type="button" id="btnSaveDraft" onclick="saveEvaluation('draft')" class="bg-gray-200 text-gray-800 hover:bg-gray-300 font-semibold py-2 px-4 rounded-lg flex items-center transition-colors">
                    <span class="mr-2">üíæ</span> Guardar Borrador
                </button>
                
                <button type="button" id="btnPublish" onclick="saveEvaluation('published')" class="btn-primary text-white font-semibold py-2 px-6 rounded-lg shadow-md flex items-center hover:bg-blue-700 transition-colors">
                    <span class="mr-2">üöÄ</span> Publicar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h3 id="confirmModalTitle" class="text-lg font-bold mb-2">Confirmar Acci√≥n</h3>
            <p id="confirmModalText" class="text-gray-600 mb-6">¬øEst√°s seguro?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirmOkBtn" class="bg-red-500 text-white font-semibold py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Importaci√≥n/Exportaci√≥n -->
    <div id="importExportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 id="importExportTitle" class="text-xl font-bold mb-4">Importar Datos</h3>
            <form id="importForm" class="space-y-4">
                 <input type="hidden" id="importDataType">
                <div>
                    <label class="block text-sm font-medium">Archivo CSV</label>
                    <input type="file" id="csvFileInput" accept=".csv" class="mt-1 w-full text-sm text-gray-500
                      file:mr-4 file:py-2 file:px-4
                      file:rounded-full file:border-0
                      file:text-sm file:font-semibold
                      file:bg-blue-50 file:text-blue-700
                      hover:file:bg-blue-100" required/>
                </div>
                 <div class="flex items-start">
                    <div class="flex items-center h-5">
                      <input id="overwriteDataCheckbox" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                    </div>
                    <div class="ml-3 text-sm">
                      <label for="overwriteDataCheckbox" class="font-medium text-gray-700">Sobrescribir datos existentes</label>
                      <p class="text-gray-500">Si se marca, los datos del CSV reemplazar√°n los datos existentes con el mismo ID.</p>
                    </div>
                  </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeImportModal()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Importar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: A√±adir/Editar Insignia -->
     <div id="badgeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h3 id="badgeModalTitle" class="text-xl font-bold mb-4">A√±adir Insignia</h3>
            <form id="badgeForm" class="space-y-4">
                <input type="hidden" id="badgeId">
                <input type="hidden" id="isGlobalBadge">
                <div>
                    <label class="block text-sm font-medium">Nombre de la Insignia</label>
                    <input type="text" id="badgeName" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Icono (Emoji)</label>
                    <input type="text" id="badgeIcon" class="mt-1 w-full border border-gray-300 rounded-lg p-2" placeholder="Ej: üèÜ" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Descripci√≥n</label>
                    <textarea id="badgeDescription" class="mt-1 w-full border border-gray-300 rounded-lg p-2" rows="3" required></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeBadgeModal()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Guardar Insignia</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Otorgar Insignias -->
     <div id="grantBadgeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-xl max-h-[80vh] flex flex-col p-6">
            <h3 class="text-xl font-bold mb-4 flex-shrink-0">Otorgar Insignias</h3>
            <div id="grantBadgeList" class="space-y-4 overflow-y-auto flex-grow pr-2">
                <!-- Lista de insignias se cargar√° aqu√≠ -->
            </div>
            <div class="flex justify-end space-x-3 pt-6 flex-shrink-0">
                <button type="button" onclick="closeGrantBadgeModal()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cerrar</button>
            </div>
        </div>
    </div>
<div id="massExportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 flex flex-col max-h-[90vh]">
            <div class="border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-gray-800">Exportar Evaluaciones</h3>
                <p class="text-sm text-gray-500">Selecciona los supervisores y asesores espec√≠ficos que deseas respaldar.</p>
            </div>
            
            <form id="massExportForm" class="flex-grow flex flex-col overflow-hidden">
                <div class="grid grid-cols-2 gap-4 mb-4 bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <div>
                        <label class="block text-xs font-bold text-blue-800 uppercase">Mes</label>
                        <select id="massExportMonth" class="mt-1 w-full border border-blue-200 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500">
                            <option value="all">Todos los meses</option>
                            </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-blue-800 uppercase">A√±o</label>
                        <select id="massExportYear" class="mt-1 w-full border border-blue-200 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500">
                            </select>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-2 px-1">
                    <label class="block text-sm font-bold text-gray-700">Selecci√≥n de Equipo</label>
                    <div class="space-x-3 text-xs">
                        <button type="button" onclick="toggleTree(true)" class="text-blue-600 hover:underline">Expandir Todo</button>
                        <span class="text-gray-300">|</span>
                        <button type="button" onclick="toggleTree(false)" class="text-blue-600 hover:underline">Contraer Todo</button>
                    </div>
                </div>
                
                <div id="exportTreeContainer" class="border rounded-lg overflow-y-auto flex-grow bg-gray-50 p-2 space-y-2" style="min-height: 200px;">
                    <div class="flex items-center justify-center h-full text-gray-400">
                        <p>Cargando estructura...</p>
                    </div>
                </div>

                <div class="flex justify-between items-center pt-6 mt-auto border-t">
                    <div class="text-xs text-gray-500">
                        <span id="selectionCount">0</span> asesores seleccionados
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" onclick="document.getElementById('massExportModal').classList.add('hidden')" class="bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-50">Cancelar</button>
                        
                        <button type="button" onclick="viewSingleEvaluationFromExport()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            Ver Evaluaci√≥n
                        </button>
                        <button type="submit" class="btn-primary text-white font-semibold py-2 px-6 rounded-lg shadow-md flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Generar Archivos
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div id="readOnlyEvaluationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                     <div>
                         <h3 class="text-xl font-bold text-gray-800" id="readOnlyModalTitle">Detalle de Evaluaci√≥n</h3>
                         <p class="text-sm text-gray-500" id="readOnlyModalSubtitle">Visualizando resultados</p>
                     </div>
                     <button onclick="document.getElementById('readOnlyEvaluationModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                
                <div id="readOnlyContent" class="p-6 overflow-y-auto flex-grow bg-slate-50 space-y-6">
                    <div class="flex justify-center py-10"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div></div>
                </div>
    
                <div class="p-4 border-t bg-white flex justify-end">
                    <button onclick="document.getElementById('readOnlyEvaluationModal').classList.add('hidden')" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Cerrar</button>
                </div>
            </div>
        </div>
    
    <!-- SCRIPT PRINCIPAL DE LA APLICACI√ìN -->
    <script type="module" defer>
        // 1. IMPORTAR LIBRER√çAS (Mantenemos las versiones CDN que s√≠ funcionan en tu web)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"; 
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, query, where, writeBatch, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // 2. TU NUEVA CONFIGURACI√ìN (Conectada a 'pruebainstrumevalcnci2026')
        const firebaseConfig = {
          apiKey: "AIzaSyD0UFqbYIK0aTCCMGAOY3LXlv23JRiUoTs",
          authDomain: "pruebainstrumevalcnci2026.firebaseapp.com",
          projectId: "pruebainstrumevalcnci2026",
          storageBucket: "pruebainstrumevalcnci2026.firebasestorage.app",
          messagingSenderId: "816234481084",
          appId: "1:816234481084:web:ae4c064d48922d7014d7b9",
          measurementId: "G-YBMMLYHY4N"
        };

        // 3. INICIALIZAR SERVICIOS (Esto faltaba en tu recorte y es CRUCIAL para guardar datos)
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // <--- Sin esto, no se guardan las evaluaciones
        const auth = getAuth(app);    // <--- Sin esto, no puedes iniciar sesi√≥n

        // Inicio de sesi√≥n an√≥nimo autom√°tico
        signInAnonymously(auth)
            .then(async () => {
                console.log("Sesi√≥n iniciada en proyecto: pruebainstrumevalcnci2026");
                
                // --- ACTIVAR CREACI√ìN AUTOM√ÅTICA ---
                await ensureAdminExists(); 
                // -----------------------------------
            })
            .catch((error) => {
                console.error("Error de autenticaci√≥n:", error);
            });

        // Variables de estado globales
        let currentUser = null;
        let usersCache = {};
        let supervisorsCache = [];
        let badgesCache = {}; 
        let templatesCache = [];            // <--- NUEVA: Faltaba esta
        let currentTemplateStructure = null; // <--- NUEVA: Faltaba esta
        let availablePeriods = {
            years: [],
            months: []
        };
        let superAdminChart = null;
        let supervisorChart = null;
        let asesorChart = null;
        let currentEvaluationBadges = []; 
        let userTableState = {
            searchTerm: '',
            sortKey: 'nombre',
            sortDirection: 'asc',
            currentPage: 1,
            rowsPerPage: 15
        };
// FUNCI√ìN NUEVA PARA A√ëADIR
        function parseCSVLine(line) {
            const values = [];
            // Expresi√≥n regular para separar por comas, respetando texto entrecomillado.
            const regex = /(?:"([^"]*(?:""[^"]*)*)"|([^,]*))(?:,|$)/g;
            if (!line || !line.trim()) {
                return [];
            }
            let match;
            while (match = regex.exec(line)) {
                let value = match[1] !== undefined 
                    ? match[1].replace(/""/g, '"') // <-- CORRECCI√ìN APLICADA
                    : match[2]; 
                values.push(value);
                if (match[0].slice(-1) !== ',') break; // Fin de la l√≠nea
            }
            return values;
        }

        // ======================= INICIALIZACI√ìN DE LA APP =======================
        
        window.onload = async () => {
            const loadingStatus = document.getElementById('loadingStatus');
            try {
                await getDoc(doc(db, "system", "health_check"));
                loadingStatus.textContent = 'Conexi√≥n exitosa. Inicializando datos...';
                await initializeDataIfNeeded();
                const configDoc = await getDoc(doc(db, "system", "config"));
                if (configDoc.exists()) {
                    const configData = configDoc.data();
                    if (configData.loginTitle) {
                        document.getElementById('loginTitle').textContent = configData.loginTitle;
                    }
                    if (configData.loginSubtitle) {
                        document.getElementById('loginSubtitle').textContent = configData.loginSubtitle;
                    }
                }
                await loadAvailablePeriods();
                await loadBadgesCache(); 
                loadingStatus.textContent = '¬°Listo para iniciar!';
                
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('loginScreen').classList.add('flex');
                    document.getElementById('loginScreen').classList.remove('hidden');
                }, 500);

            } catch (error) {
                loadingStatus.textContent = 'Error al conectar con Firebase. Revisa la consola.';
                console.error("Firebase connection error:", error);
            }
        };

        // ======================= L√ìGICA DE LOGIN Y NAVEGACI√ìN =======================

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            const loginSpinner = document.getElementById('loginSpinner');
            
            errorDiv.classList.add('hidden');
            loginButton.disabled = true;
            loginButtonText.textContent = 'Verificando...';
            loginSpinner.classList.remove('hidden');

            try {
                const userDoc = await getDoc(doc(db, "users", username));
                if (userDoc.exists() && userDoc.data().password === password) {
                    currentUser = { id: userDoc.id, ...userDoc.data() };
                    navigateToRoleScreen(currentUser.rol);
                } else {
                    errorDiv.textContent = 'Usuario o contrase√±a incorrectos.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (err) {
                errorDiv.textContent = 'Error al intentar iniciar sesi√≥n.';
                errorDiv.classList.remove('hidden');
                console.error(err);
            } finally {
                loginButton.disabled = false;
                loginButtonText.textContent = 'Ingresar';
                loginSpinner.classList.add('hidden');
            }
        });

        async function navigateToRoleScreen(role) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('flex');
            await loadBadgesCache();
            await loadUsersCache();
            await loadAvailablePeriods();

            if (role === 'superadmin') {
                document.getElementById('superAdminWelcome').textContent = `Hola, ${currentUser.nombre}`;
                document.getElementById('superAdminScreen').classList.remove('hidden');
                loadSuperAdminView();
            } else if (role === 'supervisor') {
                document.getElementById('supervisorWelcome').textContent = `Hola, ${currentUser.nombre}`;
                document.getElementById('supervisorScreen').classList.remove('hidden');
                loadSupervisorView();
            } else if (role === 'asesor') {
                document.getElementById('asesorWelcome').textContent = `Hola, ${currentUser.nombre}`;
                document.getElementById('asesorScreen').classList.remove('hidden');
                loadAsesorView();
            }
        }

        function logout() {
            currentUser = null;
            ['superAdminScreen', 'supervisorScreen', 'asesorScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById('loginScreen').classList.add('flex');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginForm').reset();
        }

        // ======================= VISTA SUPERADMIN =======================
        
        async function loadSuperAdminView() {
            renderUsersTable();
            renderGlobalBadgesTable(); 
            const configDoc = await getDoc(doc(db, "system", "config"));
            if (configDoc.exists()) {
                const configData = configDoc.data();
                document.getElementById('loginTitleInput').value = configData.loginTitle || 'Evaluaci√≥n Modular';
                document.getElementById('loginSubtitleInput').value = configData.loginSubtitle || 'Consulta tu desempe√±o.';
                document.getElementById('availableYearsInput').value = configData.availableYears?.join(', ') || '';
                document.getElementById('availableMonthsInput').value = configData.availableMonths?.join(', ') || '';
            }
            setupSuperAdminChartSelectors();
            loadSuperAdminCharts();
            // Listener para la barra de b√∫squeda de usuarios
            document.getElementById('userSearchInput').addEventListener('input', (e) => {
                userTableState.searchTerm = e.target.value.toLowerCase();
                userTableState.currentPage = 1; 
                renderUsersTable();
            });
            initAnalytics();
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            let filteredUsers = Object.values(usersCache).filter(user => 
                user.nombre.toLowerCase().includes(userTableState.searchTerm) ||
                user.id.toLowerCase().includes(userTableState.searchTerm)
            );

            filteredUsers.sort((a, b) => {
                let valA = a[userTableState.sortKey] || '';
                let valB = b[userTableState.sortKey] || '';

                if (userTableState.sortKey === 'supervisorAsignado') {
                    valA = usersCache[valA]?.nombre || 'zzz';
                    valB = usersCache[valB]?.nombre || 'zzz';
                }

                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return userTableState.sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return userTableState.sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            const totalPages = Math.ceil(filteredUsers.length / userTableState.rowsPerPage);
            if (userTableState.currentPage > totalPages && totalPages > 0) {
                userTableState.currentPage = totalPages;
            }
             if (userTableState.currentPage < 1) {
                userTableState.currentPage = 1;
            }
            const startIndex = (userTableState.currentPage - 1) * userTableState.rowsPerPage;
            const paginatedUsers = filteredUsers.slice(startIndex, startIndex + userTableState.rowsPerPage);

            if (paginatedUsers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-4">No se encontraron usuarios.</td></tr>`;
            } else {
                paginatedUsers.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${user.nombre}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.rol === 'supervisor' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">${user.rol}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.supervisorAsignado ? usersCache[user.supervisorAsignado]?.nombre || 'N/A' : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="openUserModal('${user.id}')" class="text-indigo-600 hover:text-indigo-900">Editar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            renderUserPagination(filteredUsers.length, totalPages);
        }

        function renderUserPagination(totalItems, totalPages) {
            const paginationContainer = document.getElementById('userPagination');
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            const prevDisabled = userTableState.currentPage === 1 ? 'disabled' : '';
            const nextDisabled = userTableState.currentPage === totalPages ? 'disabled' : '';

            paginationContainer.innerHTML = `
                <span>Mostrando ${Math.min(userTableState.rowsPerPage * (userTableState.currentPage - 1) + 1, totalItems)} - ${Math.min(userTableState.currentPage * userTableState.rowsPerPage, totalItems)} de ${totalItems}</span>
                <div class="space-x-2">
                    <button onclick="changeUserPage(-1)" ${prevDisabled} class="px-3 py-1 border rounded-lg bg-white disabled:opacity-50">Anterior</button>
                    <span>P√°gina ${userTableState.currentPage} de ${totalPages}</span>
                    <button onclick="changeUserPage(1)" ${nextDisabled} class="px-3 py-1 border rounded-lg bg-white disabled:opacity-50">Siguiente</button>
                </div>
            `;
        }

        function changeUserPage(direction) {
            userTableState.currentPage += direction;
            renderUsersTable();
        }

        function sortUsers(key) {
            if (userTableState.sortKey === key) {
                userTableState.sortDirection = userTableState.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                userTableState.sortKey = key;
                userTableState.sortDirection = 'asc';
            }
            userTableState.currentPage = 1;
            renderUsersTable();
        }
        
        function openUserModal(userId = null) {
            const form = document.getElementById('userForm');
            form.reset();
            document.getElementById('supervisorSelectorContainer').style.display = 'block';
            document.getElementById('deleteUserBtn').classList.add('hidden');

            const supervisorSelect = document.getElementById('userSupervisor');
            supervisorSelect.innerHTML = '<option value="">Ninguno</option>';
            supervisorsCache.forEach(sup => {
                supervisorSelect.innerHTML += `<option value="${sup.id}">${sup.nombre}</option>`;
            });
            
            if (userId) {
                const user = usersCache[userId];
                document.getElementById('userModalTitle').textContent = 'Editar Usuario';
                document.getElementById('userId').value = user.id;
                document.getElementById('userFullName').value = user.nombre;
                document.getElementById('userUsername').value = user.id;
                document.getElementById('userUsername').disabled = true;
                document.getElementById('userPassword').value = user.password;
                document.getElementById('userRole').value = user.rol;
                if (user.rol === 'asesor') {
                    supervisorSelect.value = user.supervisorAsignado || '';
                }
                document.getElementById('supervisorSelectorContainer').style.display = user.rol === 'asesor' ? 'block' : 'none';
                document.getElementById('deleteUserBtn').classList.remove('hidden');

            } else {
                document.getElementById('userModalTitle').textContent = 'A√±adir Usuario';
                document.getElementById('userId').value = ''; 
                document.getElementById('userUsername').disabled = false;
            }
            document.getElementById('userModal').classList.remove('hidden');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }
        
        document.getElementById('userRole').addEventListener('change', (e) => {
            document.getElementById('supervisorSelectorContainer').style.display = e.target.value === 'asesor' ? 'block' : 'none';
        });

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('userUsername').value.trim();
            
            if(!username){
                alert("El nombre de usuario es obligatorio.");
                return;
            }

            if (!userId) { // Solo validar si es un usuario nuevo
                if (usersCache[username]) {
                    alert("Este nombre de usuario ya existe. Por favor, elige otro.");
                    return;
                }
            }

            const userData = {
                nombre: document.getElementById('userFullName').value,
                password: document.getElementById('userPassword').value,
                rol: document.getElementById('userRole').value,
                supervisorAsignado: document.getElementById('userRole').value === 'asesor' ? document.getElementById('userSupervisor').value : null
            };
            
            const docId = userId || username;
            
            await setDoc(doc(db, "users", docId), userData);
            showSyncIndicator('superAdminSyncIndicator');
            closeUserModal();
            await loadUsersCache();
            renderUsersTable();
        });
        
        function deleteUser() {
             const userId = document.getElementById('userId').value;
             showConfirmModal('Eliminar Usuario', `¬øEst√°s seguro de que quieres eliminar a ${userId}?`, async () => {
                await deleteDoc(doc(db, "users", userId));
                showSyncIndicator('superAdminSyncIndicator');
                closeUserModal();
                await loadUsersCache();
                renderUsersTable();
            });
        }
        
        async function saveLoginTitles() {
            const title = document.getElementById('loginTitleInput').value;
            const subtitle = document.getElementById('loginSubtitleInput').value;
            await setDoc(doc(db, "system", "config"), { loginTitle: title, loginSubtitle: subtitle }, { merge: true });
            showSyncIndicator('superAdminSyncIndicator');
            alert('T√≠tulos guardados.');
        }

        async function saveAvailablePeriods() {
            const years = document.getElementById('availableYearsInput').value.split(',').map(y => y.trim()).filter(Boolean);
            const months = document.getElementById('availableMonthsInput').value.split(',').map(m => m.trim()).filter(Boolean);
            
            await setDoc(doc(db, "system", "config"), { availableYears: years, availableMonths: months }, { merge: true });
            await loadAvailablePeriods(); 
            showSyncIndicator('superAdminSyncIndicator');
            alert('Per√≠odos h√°biles guardados.');
        }

        // ======================= VISTA SUPERVISOR =======================

        async function loadSupervisorView() {
            renderAsesoresTable();
            
            // --- CAMBIO: Usamos loadTemplates en lugar de renderCategoryManagement ---
            await loadTemplates(); 
            
            // Limpiamos el panel de categor√≠as al inicio
            const catsContainer = document.getElementById('categoriesContainer');
            if (catsContainer) {
                catsContainer.innerHTML = '<p class="text-gray-400 text-center py-4">Selecciona una plantilla de la lista "Mis Plantillas" para editarla.</p>';
                const titleHeader = catsContainer.parentElement.querySelector('h2');
                if(titleHeader) titleHeader.textContent = `üìù Plantilla de Evaluaci√≥n`;
                document.getElementById('totalPonderacion').textContent = '0%';
            }
            
            renderSupervisorBadgesTable(); 
            setupSupervisorChartSelectors();
            loadSupervisorCharts();
        }

        function renderAsesoresTable() {
            const tbody = document.getElementById('asesoresTableBody');
            tbody.innerHTML = '';
            
            // 1. Obtener y filtrar asesores del supervisor actual
            const misAsesores = Object.values(usersCache).filter(u => u.supervisorAsignado === currentUser.id);

            // 2. Insertar el ordenamiento alfab√©tico aqu√≠
            misAsesores.sort((a, b) => a.nombre.localeCompare(b.nombre)); 
            // ----------------------------------------------------

            if (misAsesores.length === 0) {
                tbody.innerHTML = `<tr><td colspan="2" class="text-center text-gray-500 py-4">No tienes asesores asignados.</td></tr>`;
                return;
            }
            
            // 3. Renderizar la tabla (ahora ya ordenada)
            misAsesores.forEach(asesor => {
                const tr = document.createElement('tr');
                tr.className = 'transition-colors';
                tr.innerHTML = `
                    <td class="px-4 py-2">${asesor.nombre}</td>
                    <td class="px-4 py-2">
                        <button onclick="openEvaluationModal('${asesor.id}')" class="text-indigo-600 hover:text-indigo-900 text-sm">Evaluar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openAddAsesorModal() {
            document.getElementById('addAsesorForm').reset();
            document.getElementById('addAsesorModal').classList.remove('hidden');
        }

        function closeAddAsesorModal() {
            document.getElementById('addAsesorModal').classList.add('hidden');
        }
        
        document.getElementById('addAsesorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('asesorUsername').value.trim();
            if (!username) {
                alert("El nombre de usuario es obligatorio.");
                return;
            }
            if (usersCache[username]) {
                alert("Este nombre de usuario ya existe. Por favor, elige otro.");
                return;
            }

            const newAsesorData = {
                nombre: document.getElementById('asesorFullName').value,
                password: document.getElementById('asesorPassword').value,
                rol: 'asesor',
                supervisorAsignado: currentUser.id
            };
            
            await setDoc(doc(db, "users", username), newAsesorData);
            showSyncIndicator('supervisorSyncIndicator');
            closeAddAsesorModal();
            await loadUsersCache();
            renderAsesoresTable();
        });


        async function renderCategoryManagement() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '<div class="skeleton h-24 w-full"></div>';
            
            const templateDoc = await getDoc(doc(db, "evaluation_templates", currentUser.id));
            // APLICAMOS LA NORMALIZACI√ìN AQU√ç
            let rawCategories = templateDoc.exists() ? templateDoc.data().categorias || [] : [];
            const template = normalizeCategories(rawCategories);
            
            container.innerHTML = '';

            if (template.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center py-4">A√∫n no has creado categor√≠as para tu plantilla de evaluaci√≥n.</p>`;
            } else {
                template.forEach((cat, index) => {
                    // Generar HTML para los grupos
                    let groupsHtml = '';
                    cat.grupos.forEach(grupo => {
                        groupsHtml += `
                            <div class="mt-2 pl-4 border-l-2 border-gray-200">
                                <p class="text-xs font-bold text-gray-500 uppercase tracking-wide">
                                    Grupo: ${grupo.nombre} (${grupo.ponderacion}%)
                                </p>
                                <ul class="list-disc list-inside text-sm text-gray-600 ml-2">
                                    ${(grupo.criterios || []).map(c => `<li>${c}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    });

                    const div = document.createElement('div');
                    div.className = 'p-4 border rounded-lg bg-slate-50 relative'; // Agregu√© relative
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-lg">${cat.nombre} <span class="text-sm font-normal text-gray-500">(${cat.ponderacion || 0}%)</span></h4>
                            <div>
                                <button onclick="openCategoryModal(${index})" class="text-indigo-600 text-sm mr-2 font-medium">Editar</button>
                                <button onclick="deleteCategory(${index})" class="text-red-600 text-sm font-medium">Eliminar</button>
                            </div>
                        </div>
                        <div class="mt-2 space-y-2">
                            ${groupsHtml}
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
            updatePonderacionTotal();
        }
        // ======================= L√ìGICA DE DRAG AND DROP =======================
        
        let draggedElement = null;

        // Funci√≥n que conecta un elemento individual con los eventos de arrastre
        function addDragEvents(element) {
            element.addEventListener('dragstart', handleDragStart);
            element.addEventListener('dragend', handleDragEnd);
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging'); // A√±ade la clase visual
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging'); // Quita la clase visual
            draggedElement = null;
            
            // Limpiar clases visuales de "destino" de todas las listas
            document.querySelectorAll('.criteria-list').forEach(list => {
                list.classList.remove('drag-over');
            });
        }

        // Configura las zonas donde se pueden SOLTAR los elementos (las listas)
        function setupDropZones() {
            // Usamos delegaci√≥n de eventos en el documento para detectar las listas din√°micas
            document.addEventListener('dragover', (e) => {
                const list = e.target.closest('.criteria-list');
                if (list) {
                    e.preventDefault(); // Necesario para permitir soltar
                    list.classList.add('drag-over');
                }
            });

            document.addEventListener('dragleave', (e) => {
                const list = e.target.closest('.criteria-list');
                if (list) {
                    list.classList.remove('drag-over');
                }
            });

            document.addEventListener('drop', (e) => {
                const list = e.target.closest('.criteria-list');
                if (list && draggedElement) {
                    e.preventDefault();
                    list.classList.remove('drag-over');
                    
                    // Mover el elemento arrastrado al nuevo contenedor
                    list.appendChild(draggedElement);
                }
            });
        }
        
        // Ejecutamos esto una vez al inicio para activar las zonas de ca√≠da
        setupDropZones();
        // ======================= HELPERS PARA GESTI√ìN DE GRUPOS (V2) =======================
        // Genera el HTML de un bloque de grupo
        function addGroupBlock(groupData = null) {
            const container = document.getElementById('groupsContainer');
            const groupId = Date.now() + Math.random().toString(36).substr(2, 9); 
            
            const nombre = groupData ? groupData.nombre : '';
            const ponderacion = groupData ? groupData.ponderacion : '';
            const criterios = groupData ? groupData.criterios : [];

            const groupHtml = `
                <div class="group-block border border-gray-300 rounded-lg p-4 bg-gray-50 relative transition-all hover:shadow-md" id="group-${groupId}">
                    <button type="button" onclick="this.closest('.group-block').remove()" class="absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold text-xl" title="Eliminar Grupo">&times;</button>
                    
                    <div class="grid grid-cols-3 gap-4 mb-3">
                        <div class="col-span-2">
                            <label class="block text-xs font-semibold text-gray-500 uppercase">Nombre del Grupo</label>
                            <input type="text" class="group-name-input mt-1 w-full border-gray-300 rounded p-1.5 text-sm font-medium" placeholder="Ej. Etiqueta Telef√≥nica" value="${nombre}" required>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase">Peso en Cat. (%)</label>
                            <input type="number" class="group-weight-input mt-1 w-full border-gray-300 rounded p-1.5 text-sm text-center" placeholder="%" min="0" max="100" value="${ponderacion}" required>
                        </div>
                    </div>

                    <div class="bg-white p-3 rounded border border-gray-200">
                        <label class="block text-xs font-semibold text-gray-400 mb-2">CRITERIOS (0-10) - Arrastra para mover</label>
                        
                        <div class="criteria-list space-y-2 min-h-[50px] p-2 border border-dashed border-transparent transition-colors rounded">
                            </div>
                        
                        <button type="button" onclick="addCriterionToGroup('${groupId}')" class="mt-2 text-xs text-indigo-600 hover:text-indigo-800 font-medium flex items-center">
                            + A√±adir Criterio
                        </button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', groupHtml);

            if (criterios && criterios.length > 0) {
                criterios.forEach(crit => addCriterionToGroup(groupId, crit));
            } else if (!groupData) {
                addCriterionToGroup(groupId);
            }
        }

        // A√±ade un input de criterio dentro de un grupo espec√≠fico
        function addCriterionToGroup(groupId, value = '') {
            const groupBlock = document.getElementById(`group-${groupId}`);
            const listContainer = groupBlock.querySelector('.criteria-list');
            
            const div = document.createElement('div');
            
            // CAMBIO 1: A√±adimos la clase 'draggable-criterion' y estilos de hover
            div.className = 'draggable-criterion flex items-center space-x-2 p-1 rounded hover:bg-gray-100';
            
            // CAMBIO 2: Hacemos el elemento arrastrable
            div.setAttribute('draggable', 'true');
            
            // CAMBIO 3: A√±adimos un icono visual (‚ãÆ‚ãÆ) para indicar que se puede mover
            div.innerHTML = `
                <div class="cursor-move text-gray-400 mr-1" title="Arrastrar para mover">‚ãÆ‚ãÆ</div>
                <input type="text" class="criterion-input w-full border-b border-transparent hover:border-gray-300 focus:border-indigo-500 focus:outline-none py-1 text-sm text-gray-700 bg-transparent" placeholder="Escribe un criterio..." value="${value}" required>
                <button type="button" onclick="this.parentElement.remove()" class="text-gray-400 hover:text-red-500 text-lg leading-none">&times;</button>
            `;
            
            // CAMBIO 4: Conectamos este nuevo elemento a la l√≥gica de arrastre del Paso 2
            addDragEvents(div);

            listContainer.appendChild(div);
        }

        // ======================= GESTI√ìN DE CATEGOR√çAS (L√ìGICA V2) =======================

        async function openCategoryModal(index = null) {
            document.getElementById('categoryForm').reset();
            document.getElementById('groupsContainer').innerHTML = '';
            
            // VALIDACI√ìN CR√çTICA: Debemos saber qu√© plantilla estamos editando
            if (!activeTemplateId) {
                alert("Error: No hay una plantilla seleccionada. Selecciona una arriba primero.");
                return;
            }

            if (index !== null) {
                // MODO EDICI√ìN
                const template = templatesCache.find(t => t.id === activeTemplateId);
                // Normalizamos para asegurar estructura
                const normalizedCategories = normalizeCategories(template.categorias || []);
                const category = normalizedCategories[index];

                document.getElementById('categoryModalTitle').textContent = 'Editar Categor√≠a';
                document.getElementById('categoryId').value = index;
                document.getElementById('categoryName').value = category.nombre;
                document.getElementById('categoryPonderacion').value = category.ponderacion || 0;

                if (category.grupos && category.grupos.length > 0) {
                    category.grupos.forEach(grupo => addGroupBlock(grupo));
                }
            } else {
                // MODO CREACI√ìN
                document.getElementById('categoryModalTitle').textContent = 'Nueva Categor√≠a';
                document.getElementById('categoryId').value = '';
                addGroupBlock(); // Grupo vac√≠o por defecto
            }

            document.getElementById('categoryModal').classList.remove('hidden');
        }

        async function submitCategoryForm() {
            // 1. Validaciones
            if (!activeTemplateId) return alert("No hay plantilla seleccionada.");
            
            const name = document.getElementById('categoryName').value.trim();
            const ponderacion = document.getElementById('categoryPonderacion').value;
            
            if (!name || !ponderacion) {
                return alert("Completa nombre y ponderaci√≥n.");
            }

            // 2. Construir Objeto
            const newCategory = {
                nombre: name,
                ponderacion: parseInt(ponderacion) || 0,
                grupos: [] 
            };

            const groupBlocks = document.querySelectorAll('.group-block');
            groupBlocks.forEach(block => {
                const groupName = block.querySelector('.group-name-input').value.trim();
                const groupWeight = parseInt(block.querySelector('.group-weight-input').value) || 0;
                const criteriaInputs = block.querySelectorAll('.criterion-input');
                const criterios = Array.from(criteriaInputs).map(i => i.value.trim()).filter(v => v !== '');

                if (groupName && criterios.length > 0) {
                    newCategory.grupos.push({ nombre: groupName, ponderacion: groupWeight, criterios: criterios });
                }
            });

            if (newCategory.grupos.length === 0) return alert("A√±ade al menos un grupo con criterios.");

            // 3. Guardar en la colecci√≥n 'templates' (NO en evaluation_templates)
            const index = document.getElementById('categoryId').value;
            const templateRef = doc(db, "templates", activeTemplateId);
            
            try {
                const templateDoc = await getDoc(templateRef);
                let categorias = normalizeCategories(templateDoc.data().categorias || []);

                if (index !== '') {
                    categorias[parseInt(index)] = newCategory;
                } else {
                    categorias.push(newCategory);
                }

                await updateDoc(templateRef, { categorias }); // Usamos updateDoc para no borrar el resto del doc
                
                showSyncIndicator('supervisorSyncIndicator');
                closeCategoryModal();
                // Actualizar la vista y el cach√©
                await loadTemplates(); 
                setActiveTemplate(activeTemplateId); 
            } catch (e) {
                console.error(e);
                alert("Error al guardar categor√≠a: " + e.message);
            }
        }

        async function deleteCategory(index) {
            if (!activeTemplateId) return;
            
            showConfirmModal('Eliminar Categor√≠a', '¬øEst√°s seguro?', async () => {
                const templateRef = doc(db, "templates", activeTemplateId);
                const templateDoc = await getDoc(templateRef);
                
                if (templateDoc.exists()) {
                    let categorias = normalizeCategories(templateDoc.data().categorias || []);
                    categorias.splice(index, 1);
                    
                    await updateDoc(templateRef, { categorias });
                    showSyncIndicator('supervisorSyncIndicator');
                    await loadTemplates();
                    setActiveTemplate(activeTemplateId);
                }
            });
        }

        function updatePonderacionTotal() {
            // Calcula basado en la plantilla activa en memoria o cach√©
            const template = templatesCache.find(t => t.id === activeTemplateId);
            const categorias = template ? (template.categorias || []) : [];
            
            const total = categorias.reduce((sum, cat) => sum + (parseInt(cat.ponderacion) || 0), 0);
            const totalEl = document.getElementById('totalPonderacion');
            if(totalEl) {
                totalEl.textContent = `${total}%`;
                totalEl.className = `font-bold text-lg ${total === 100 ? 'text-green-600' : 'text-red-600'}`;
            }
        }


        // ======================= L√ìGICA DE EVALUACI√ìN (SUPERVISOR) =======================
        
        // Abrir modal y preparar selector
        async function openEvaluationModal(asesorId) {
            document.getElementById('evaluationModalTitle').textContent = `Evaluando a ${usersCache[asesorId].nombre}`;
            document.getElementById('evaluationAsesorId').value = asesorId;
            
            // Inicializar Fechas
            const monthSelect = document.getElementById('evaluationMonth');
            const yearSelect = document.getElementById('evaluationYear');
            const currentMonthName = new Date().toLocaleString('es-ES', { month: 'long' });
            
            monthSelect.innerHTML = availablePeriods.months.map(m => `<option value="${m}" ${m.toLowerCase() === currentMonthName.toLowerCase() ? 'selected' : ''}>${m}</option>`).join('');
            yearSelect.innerHTML = availablePeriods.years.map(y => `<option value="${y}">${y}</option>`).join('');
        
            // 1. Validar que existan plantillas
            if (templatesCache.length === 0) {
                alert("Primero debes crear una plantilla en el panel de Supervisor.");
                document.getElementById('evaluationModal').classList.add('hidden'); // Cerrar si estaba abri√©ndose
                return;
            }
        
            // 2. Llenar Selector
            const selector = document.getElementById('evaluationTemplateSelector');
            selector.innerHTML = '<option value="" disabled selected>-- Selecciona una plantilla --</option>';
            
            templatesCache.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.nombre;
                selector.appendChild(opt);
            });
        
            // 3. Resetear advertencias
            document.getElementById('templateChangeWarning').classList.add('hidden');
            
            // 4. Mostrar Modal y Cargar Datos
            document.getElementById('evaluationModal').classList.remove('hidden');
            
            // IMPORTANTE: Esperamos a cargar datos para ver si ya tiene plantilla asignada
            await loadEvaluationFormData(); 
        }
        
        // Manejo del cambio de plantilla (Warning de borrado)
        function handleTemplateChange() {
            const warning = document.getElementById('templateChangeWarning');
            warning.classList.remove('hidden'); // Mostrar advertencia
            loadEvaluationFormData(true); // Recargar formulario (true = forzar cambio)
        }

        // Carga el formulario bas√°ndose en la plantilla seleccionada o el snapshot guardado
        const loadEvaluationFormData = async (forceTemplateChange = false) => {
            const asesorId = document.getElementById('evaluationAsesorId').value;
            const month = document.getElementById('evaluationMonth').value;
            const year = document.getElementById('evaluationYear').value;
            const selector = document.getElementById('evaluationTemplateSelector');
            const container = document.getElementById('evaluationCategoriesContainer');
            const btnPublish = document.getElementById('btnPublish');
            const btnSave = document.getElementById('btnSaveDraft');

            container.innerHTML = '<div class="skeleton h-48 w-full"></div>';

            // 1. Buscar Evaluaci√≥n Existente
            const evalId = `${asesorId}_${year}_${month}`;
            const evalDoc = await getDoc(doc(db, "evaluations", evalId));
            const existingData = evalDoc.exists() ? evalDoc.data() : null;

            let templateToRender = null;
            let isReadOnly = false;
            currentEvaluationBadges = existingData ? existingData.insigniasOtorgadas || [] : [];

            // --- CASO A: Evaluaci√≥n Publicada (Usar Snapshot) ---
            if (existingData && existingData.status === 'published') {
                templateToRender = existingData.templateSnapshot;
                
                // Mostrar opci√≥n archivada en el selector visualmente
                if (![...selector.options].some(o => o.value === existingData.templateId)) {
                    const opt = document.createElement('option');
                    opt.value = existingData.templateId;
                    opt.textContent = `${existingData.templateName} (Archivada)`;
                    selector.appendChild(opt);
                }
                selector.value = existingData.templateId;

                // Bloqueo de seguridad
                if (currentUser.rol === 'superadmin') {
                    isReadOnly = false; 
                    selector.disabled = false;
                    container.insertAdjacentHTML('afterbegin', `<div class="w-full bg-red-100 text-red-800 p-2 rounded mb-2 text-center text-xs font-bold">MODO SUPERADMIN: Editando documento publicado</div>`);
                } else {
                    isReadOnly = true;
                    selector.disabled = true;
                    if(btnPublish) btnPublish.classList.add('hidden');
                    if(btnSave) btnSave.classList.add('hidden');
                    container.insertAdjacentHTML('afterbegin', `<div class="w-full bg-green-100 text-green-800 p-2 rounded mb-2 text-center text-xs font-bold">Evaluaci√≥n Publicada (Solo Lectura)</div>`);
                }

            // --- CASO B: Borrador o Nueva (Usar Selector) ---
            } else {
                isReadOnly = false;
                if(btnPublish) btnPublish.classList.remove('hidden');
                if(btnSave) btnSave.classList.remove('hidden');
                selector.disabled = false;

                let targetTemplateId = selector.value;

                // Si ya existe borrador, pre-seleccionar su plantilla
                if (!forceTemplateChange && existingData && existingData.templateId) {
                    targetTemplateId = existingData.templateId;
                    selector.value = targetTemplateId;
                }

                if (!targetTemplateId) {
                    container.innerHTML = '<div class="text-center py-10 text-gray-400">Selecciona una plantilla arriba para comenzar.</div>';
                    return;
                }

                // Buscar estructura en el CACH√â DE PLANTILLAS
                const tplObj = templatesCache.find(t => t.id === targetTemplateId);
                if (tplObj) {
                    templateToRender = normalizeCategories(tplObj.categorias || []);
                }
            }

            // Guardamos referencia global para usar al guardar
            currentTemplateStructure = templateToRender;

            // Renderizar usando la funci√≥n helper existente
            renderForm(container, templateToRender, existingData, isReadOnly);
        };
                
        // Funci√≥n helper para renderizar (VERSI√ìN COMPLETA)
        function renderForm(container, template, data, isReadOnly) {
            container.innerHTML = '';
            const d = data || {};
            const m = d.metricas || {};
            const disabledAttr = isReadOnly ? 'disabled class="bg-gray-100 cursor-not-allowed w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 font-bold text-gray-700"' : 'class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 font-bold text-gray-700"';
            const disabledAttrSimple = isReadOnly ? 'disabled class="bg-gray-100 cursor-not-allowed mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"' : 'class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"';

            // 1. M√âTRICAS FIJAS
            container.innerHTML += `
                <div class="p-4 border rounded-lg bg-gray-50 mb-6 shadow-sm">
                    <h4 class="font-bold mb-4 text-gray-700 border-b pb-2">M√©tricas de Productividad (Ingreso Manual)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <h5 class="text-xs font-bold text-blue-800 uppercase mb-2">üìû Gesti√≥n Telef√≥nica</h5>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="block text-xs font-medium text-gray-600 mb-1">Llamadas</label><input type="number" id="metricaLlamadas" value="${m.llamadas || ''}" ${disabledAttr}></div>
                                <div><label class="block text-xs font-medium text-gray-600 mb-1">Cumplimiento (%)</label><input type="number" id="metricaLlamadasPct" value="${m.llamadasPct || ''}" ${disabledAttr}></div>
                            </div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                            <h5 class="text-xs font-bold text-orange-800 uppercase mb-2">üéì Gesti√≥n de Alumnos</h5>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="block text-xs font-medium text-gray-600 mb-1">Alumnos</label><input type="number" id="metricaAlumnos" value="${m.alumnos || ''}" ${disabledAttr}></div>
                                <div><label class="block text-xs font-medium text-gray-600 mb-1">Cumplimiento (%)</label><input type="number" id="metricaAlumnosPct" value="${m.alumnosPct || ''}" ${disabledAttr}></div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div><label class="block text-sm font-medium text-gray-600">Calificaci√≥n General</label><input type="number" id="evalGeneralScore" value="${d.calificacionGeneral || ''}" class="mt-1 w-full p-2 border border-gray-300 rounded-lg bg-gray-200 text-blue-800 font-bold" readonly></div>
                         <div><label class="block text-sm font-medium text-gray-600">Enlace "Detalles"</label><input type="url" id="evalDetailsLink" value="${d.enlaceDetalles || ''}" ${disabledAttrSimple}></div>
                         <div><label class="block text-sm font-medium text-gray-600">Enlace "Plan de Trabajo"</label><input type="url" id="evalWorkPlanLink" value="${d.enlacePlanTrabajo || ''}" ${disabledAttrSimple}></div>
                    </div>
                    <div class="mt-4"><label class="block text-sm font-medium text-gray-600">Comentarios Generales</label><textarea id="evalGeneralComments" rows="3" ${disabledAttrSimple}>${d.comentariosGenerales || ''}</textarea></div>
                    <div class="mt-4"><label class="block text-sm font-medium text-gray-600">Texto para "Plan de Trabajo"</label><textarea id="evalWorkPlanText" rows="3" ${disabledAttrSimple}>${d.textoPlanTrabajo || ''}</textarea></div>
                </div>
            `;

            // 2. RENDER DIN√ÅMICO DE PLANTILLA
            if (template) {
                template.forEach(cat => {
                    const catData = d.categoriasEvaluadas ? d.categoriasEvaluadas[cat.nombre] || {} : {};
                    let groupsHtml = '';
                    
                    cat.grupos.forEach(grupo => {
                        const criteriaHtml = grupo.criterios.map(crit => `
                             <div class="grid grid-cols-4 gap-2 items-center mb-2">
                                <label class="text-sm col-span-3 text-gray-700">${crit}</label>
                                <input type="number" min="0" max="10" 
                                       data-category="${cat.nombre}" 
                                       data-criterion="${crit}" 
                                       value="${(catData.criterios && catData.criterios[crit] !== undefined) ? catData.criterios[crit] : ''}" 
                                       class="criterion-score w-full p-1 border border-gray-300 rounded-lg text-center focus:ring-indigo-500 focus:border-indigo-500 ${isReadOnly ? 'bg-gray-100 cursor-not-allowed' : ''}"
                                       placeholder="-" ${isReadOnly ? 'disabled' : ''}>
                             </div>
                        `).join('');

                        groupsHtml += `
                            <div class="mb-4 last:mb-0">
                                <h5 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 border-b border-gray-100 pb-1">
                                    ${grupo.nombre} <span class="font-normal normal-case">(${grupo.ponderacion}%)</span>
                                </h5>
                                <div class="pl-2">${criteriaHtml}</div>
                            </div>
                        `;
                    });

                    container.innerHTML += `
                        <div class="p-5 border rounded-lg bg-white shadow-sm mb-4">
                            <h4 class="font-bold text-lg text-blue-900 mb-4">${cat.nombre}</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">${groupsHtml}</div>
                                <div class="space-y-4">
                                    <div><label class="block text-sm font-bold text-gray-700 mb-1">Comentarios (Calidad)</label><textarea data-category="${cat.nombre}" name="comment_calidad" rows="3" class="w-full p-2 border border-gray-300 rounded-lg ${isReadOnly ? 'bg-gray-100' : ''}" ${isReadOnly ? 'disabled' : ''}>${catData.comentarioCalidad || ''}</textarea></div>
                                    <div><label class="block text-sm font-bold text-gray-700 mb-1">Comentarios (Supervisi√≥n)</label><textarea data-category="${cat.nombre}" name="comment_supervision" rows="3" class="w-full p-2 border border-gray-300 rounded-lg ${isReadOnly ? 'bg-gray-100' : ''}" ${isReadOnly ? 'disabled' : ''}>${catData.comentarioSupervision || ''}</textarea></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Activar c√°lculo autom√°tico si es editable
                if(!isReadOnly) {
                    container.addEventListener('input', calculateWeightedScore);
                    // C√°lculo inicial
                    setTimeout(calculateWeightedScore, 100);
                }
            }
        }

        document.getElementById('evaluationMonth').addEventListener('change', loadEvaluationFormData);
        document.getElementById('evaluationYear').addEventListener('change', loadEvaluationFormData);

        function closeEvaluationModal() {
            document.getElementById('evaluationModal').classList.add('hidden');
        }
        
        async function saveEvaluation(status) {
            const asesorId = document.getElementById('evaluationAsesorId').value;
            const month = document.getElementById('evaluationMonth').value;
            const year = document.getElementById('evaluationYear').value;
            const templateId = document.getElementById('evaluationTemplateSelector').value;
            const evalId = `${asesorId}_${year}_${month}`;
        
            // 1. Validaciones
            if (!currentTemplateStructure || !templateId) {
                alert("Selecciona una plantilla v√°lida.");
                return;
            }
        
            // Confirmaci√≥n de seguridad al publicar
            if (status === 'published' && !confirm("¬øEst√°s seguro de PUBLICAR esta evaluaci√≥n?\n\n- Ser√° visible inmediatamente para el asesor.\n- Se generar√° un registro hist√≥rico inmutable.")) {
                return;
            }
        
            // 2. Recolectar M√©tricas Manuales
            const metricas = {
                llamadas: document.getElementById('metricaLlamadas').value || 0,
                llamadasPct: document.getElementById('metricaLlamadasPct').value || 0,
                alumnos: document.getElementById('metricaAlumnos').value || 0,
                alumnosPct: document.getElementById('metricaAlumnosPct').value || 0
            };
        
            // 3. Recolectar Datos Din√°micos (Categor√≠as)
            const categoriasEvaluadas = {};
            const inputs = document.querySelectorAll('.criterion-score');
            
            inputs.forEach(input => {
                const catName = input.dataset.category;
                const critName = input.dataset.criterion;
                const val = input.value;
        
                if (!categoriasEvaluadas[catName]) {
                    categoriasEvaluadas[catName] = { 
                        criterios: {},
                        comentarioCalidad: document.querySelector(`textarea[name="comment_calidad"][data-category="${catName}"]`)?.value || '',
                        comentarioSupervision: document.querySelector(`textarea[name="comment_supervision"][data-category="${catName}"]`)?.value || ''
                    };
                }
                if (val !== '') {
                    categoriasEvaluadas[catName].criterios[critName] = parseInt(val);
                }
            });
        
            // 4. Construir Objeto Final
            const evalData = {
                asesorId, 
                supervisorId: currentUser.id, 
                month, 
                year,
                metricas,
                categoriasEvaluadas,
                calificacionGeneral: document.getElementById('evalGeneralScore').value || 0,
                enlaceDetalles: document.getElementById('evalDetailsLink').value || '',
                enlacePlanTrabajo: document.getElementById('evalWorkPlanLink').value || '',
                comentariosGenerales: document.getElementById('evalGeneralComments').value || '',
                textoPlanTrabajo: document.getElementById('evalWorkPlanText').value || '',
                insigniasOtorgadas: currentEvaluationBadges, 
                
                // CAMPOS NUEVOS PARA SNAPSHOT
                templateId: templateId,
                templateName: templatesCache.find(t => t.id === templateId)?.nombre || 'Plantilla',
                status: status, // 'draft' o 'published'
                updatedAt: serverTimestamp()
            };
        
            // SNAPSHOT M√ÅGICO: Si se publica, congelamos la estructura
            if (status === 'published') {
                evalData.templateSnapshot = currentTemplateStructure; 
            }
        
            try {
                await setDoc(doc(db, "evaluations", evalId), evalData, { merge: true });
                
                if (status === 'published') {
                    alert("‚úÖ Evaluaci√≥n Publicada Correctamente");
                    closeEvaluationModal();
                } else {
                    // Feedback visual sutil para borrador
                     const btn = document.getElementById('btnSaveDraft');
                     const originalText = btn.innerHTML;
                     btn.innerHTML = '<span class="mr-2">‚úîÔ∏è</span> Guardado';
                     btn.classList.add('bg-green-200');
                     setTimeout(() => {
                         btn.innerHTML = originalText;
                         btn.classList.remove('bg-green-200');
                     }, 1500);
                }
                
                // Actualizar gr√°ficas si es necesario
                if(document.getElementById('supervisorScreen').classList.contains('hidden') === false){
                     loadSupervisorCharts();
                }
                
            } catch (e) {
                console.error(e);
                alert("Error al guardar: " + e.message);
            }
        }


        // ======================= VISTA ASESOR =======================

        async function loadAsesorView() {
            const monthSelect = document.getElementById('monthSelector');
            const yearSelect = document.getElementById('yearSelector');
            const currentMonthName = new Date().toLocaleString('es-ES', { month: 'long' });

            monthSelect.innerHTML = availablePeriods.months.map(m => `<option value="${m}" ${m.toLowerCase() === currentMonthName.toLowerCase() ? 'selected' : ''}>${m}</option>`).join('');
            yearSelect.innerHTML = availablePeriods.years.map(y => `<option value="${y}">${y}</option>`).join('');

            monthSelect.addEventListener('change', renderAsesorDashboard);
            yearSelect.addEventListener('change', renderAsesorDashboard);
            
            switchAsesorTab('resumen');
            renderAsesorDashboard();
        }

        function switchAsesorTab(tabName) {
            document.querySelectorAll('#asesorTabContent > div').forEach(div => div.classList.add('hidden'));
            document.querySelectorAll('.asesor-tab').forEach(btn => {
                btn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                btn.classList.add('text-gray-600', 'hover:bg-slate-300');
            });
            
            const activeTab = document.getElementById(`${tabName}-tab`);
            activeTab.classList.remove('hidden');
            const button = document.querySelector(`.asesor-tab[onclick="switchAsesorTab('${tabName}')"]`);
            button.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
            button.classList.remove('text-gray-600', 'hover:bg-slate-300');

            // Cargar contenido din√°mico al cambiar de pesta√±a
            if (tabName === 'resumen') renderAsesorDashboard();
            if (tabName === 'tendencias') renderAsesorCharts();
            if (tabName === 'insignias') renderAsesorBadges();
            if (tabName === 'plan') renderAsesorPlan();
        };

        async function renderAsesorPlan() {
            const month = document.getElementById('monthSelector').value;
            const year = document.getElementById('yearSelector').value;
            const evalId = `${currentUser.id}_${year}_${month}`;
            const container = document.getElementById('plan-tab');

            const evalDoc = await getDoc(doc(db, "evaluations", evalId));
             if (!evalDoc.exists()) {
                container.innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow-lg"><h3 class="text-xl font-bold">Sin Plan de Trabajo</h3><p class="text-gray-600 mt-2">No hay un plan de trabajo disponible para ${month} de ${year}.</p></div>`;
                return;
             }
             const data = evalDoc.data();
             container.innerHTML = `
                 <div class="bg-white rounded-xl shadow-md p-6 text-center border-t-4 border-orange-500">
                     <h3 class="font-bold text-2xl mb-4">üöÄ Mi Plan de Trabajo</h3>
                     <p class="text-gray-600 mb-6 max-w-xl mx-auto">${data.textoPlanTrabajo || 'Tu supervisor ha preparado un plan de trabajo para ti. Haz clic en el bot√≥n para verlo.'}</p>
                     <a href="${data.enlacePlanTrabajo || '#'}" target="_blank" class="btn-secondary inline-block text-white font-semibold py-3 px-8 rounded-lg">Acceder a mi Plan de Trabajo</a>
                 </div>`;
        }

        async function renderAsesorDashboard() {
            const month = document.getElementById('monthSelector').value;
            const year = document.getElementById('yearSelector').value;
            const evalId = `${currentUser.id}_${year}_${month}`;
            const container = document.getElementById('resumen-tab');
            
            container.innerHTML = '<div class="skeleton h-64 w-full"></div>';
            
            try {
                const evalDoc = await getDoc(doc(db, "evaluations", evalId));
            
                if (!evalDoc.exists()) {
                    container.innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow-lg"><h3 class="text-xl font-bold">Sin Evaluaci√≥n</h3><p class="text-gray-600 mt-2">No hay evaluaci√≥n para ${month} ${year}.</p></div>`;
                    return;
                }

                const data = evalDoc.data();

                // FILTRO DE PRIVACIDAD
                if (data.status !== 'published') {
                     container.innerHTML = `<div class="bg-blue-50 border-l-4 border-blue-400 p-6 rounded shadow-sm text-center"><h3 class="text-lg font-bold text-blue-800">Evaluaci√≥n en Proceso</h3><p class="text-sm text-blue-700">Tu supervisor est√° trabajando en este periodo.</p></div>`;
                     return;
                }

                // ELEGIR PLANTILLA (Snapshot tiene prioridad)
                let template = [];
                if (data.templateSnapshot) {
                    template = data.templateSnapshot;
                } else {
                    // Fallback Legacy
                    const tplDoc = await getDoc(doc(db, "evaluation_templates", data.supervisorId));
                    template = normalizeCategories(tplDoc.exists() ? tplDoc.data().categorias || [] : []);
                }
                
                // ... (El resto de tu l√≥gica de renderizado visual se mantiene igual, 
                // solo aseg√∫rate de usar la variable 'template' que acabamos de definir arriba)
                // ... [Copia aqu√≠ el resto del c√≥digo de renderizado de tu funci√≥n anterior]
                
                // NOTA IMPORTANTE: Como tu funci√≥n anterior mezclaba la obtenci√≥n de datos con el HTML,
                // aseg√∫rate de que el bucle 'template.forEach' use esta variable 'template'.
                
                // AQU√ç PEGA TU C√ìDIGO DE RENDERIZADO VISUAL (lines 2276 en adelante de tu archivo original)
                // Asegur√°ndote de que empiece con: let categoriesHTML = ''; if (template.length > 0) { ...
                
                // Para facilitarte, aqu√≠ est√° el inicio del renderizado:
                let categoriesHTML = '';
                if (template.length > 0) {
                    template.forEach(cat => {
                        const catName = cat.nombre;
                        const catData = data.categoriasEvaluadas && data.categoriasEvaluadas[catName] ? data.categoriasEvaluadas[catName] : {};
                        const score = parseFloat(catData.puntaje || 0);
                        // ... resto del HTML de categor√≠as ...
                        // (Copia exactamente tu l√≥gica visual de categor√≠as aqu√≠)
                        
                        // --- REEMPLAZA ESTE COMENTARIO CON TU C√ìDIGO VISUAL EXISTENTE ---
                        const ponderacion = cat.ponderacion || 0;
                        const scoreClass = score >= 9 ? 'score-high' : score >= 7 ? 'score-medium' : 'score-low';
                        const borderClass = score >= 9 ? 'border-green-500' : score >= 7 ? 'border-amber-500' : 'border-red-500';

                        let groupsHtml = '';
                        if (cat.grupos && cat.grupos.length > 0) {
                            cat.grupos.forEach(grupo => {
                                let gSum = 0; let gCount = 0; let criteriaListHtml = '';
                                grupo.criterios.forEach(crit => {
                                    const critScore = catData.criterios ? catData.criterios[crit] : undefined;
                                    if (critScore !== undefined) {
                                        gSum += parseFloat(critScore); gCount++;
                                        criteriaListHtml += `<li class="flex justify-between items-center py-1 border-b border-gray-100 last:border-0 text-sm"><span class="text-gray-600">${crit}</span><span class="font-bold text-gray-800">${critScore}</span></li>`;
                                    } else {
                                         criteriaListHtml += `<li class="flex justify-between items-center py-1 border-b border-gray-100 last:border-0 text-sm opacity-50"><span class="text-gray-500">${crit}</span><span class="text-xs text-gray-400">N/A</span></li>`;
                                    }
                                });
                                const groupAvg = gCount > 0 ? (gSum / gCount).toFixed(2) : '0.00';
                                groupsHtml += `<div class="mb-3 bg-slate-50 rounded-lg border border-slate-200 overflow-hidden"><div class="px-3 py-2 bg-slate-100 flex justify-between items-center border-b border-slate-200"><div><span class="font-bold text-gray-700 text-xs uppercase tracking-wide">${grupo.nombre}</span><span class="text-xs text-gray-500 ml-1">(${grupo.ponderacion}%)</span></div><span class="font-bold text-blue-600 text-sm bg-white px-2 py-0.5 rounded shadow-sm">${groupAvg}</span></div><ul class="px-3 py-2 bg-white">${criteriaListHtml || '<li class="text-xs text-gray-400 italic">Sin datos</li>'}</ul></div>`;
                            });
                        } else {
                            groupsHtml = '<p class="text-sm text-gray-500 italic">Sin estructura de grupos definida.</p>';
                        }

                        categoriesHTML += `<div class="bg-white rounded-xl shadow-md p-5 border-l-4 ${borderClass} transition-all duration-300 hover:shadow-lg mb-4"><div class="flex justify-between items-start mb-4"><div><h4 class="font-bold text-lg text-gray-800">${catName}</h4><span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded-full">Ponderaci√≥n Global: ${ponderacion}%</span></div><div class="score-circle ${scoreClass} shadow-md transform scale-110">${score.toFixed(2)}</div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-sm bg-gray-50 p-3 rounded-lg"><div><strong class="text-gray-700 block mb-1">üìù Comentarios Calidad:</strong><p class="text-gray-600 italic">${catData.comentarioCalidad || 'Sin comentarios.'}</p></div><div><strong class="text-gray-700 block mb-1">üìã Comentarios Supervisi√≥n:</strong><p class="text-gray-600 italic">${catData.comentarioSupervision || 'Sin comentarios.'}</p></div></div><div><button onclick="toggleCriteria(this)" class="flex items-center text-sm text-blue-600 font-bold hover:text-blue-800 transition-colors w-full text-left focus:outline-none"><span class="mr-1">Ver Desglose por Grupos</span><svg class="w-4 h-4 criteria-toggle transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div class="criteria-content mt-2">${groupsHtml}</div></div></div>`;
                    });
                } else {
                    categoriesHTML = `<div class="p-4 bg-yellow-50 text-yellow-700 rounded-lg">No se encontr√≥ la estructura de evaluaci√≥n.</div>`;
                }
                
                // ... (El resto del renderizado de M√©tricas y Feedback tambi√©n se mantiene igual)
                // ... [Copia aqu√≠ el resto del HTML de tu funci√≥n original: m√©tricas, feedback, botones]
                const calificacionGeneral = parseFloat(data.calificacionGeneral || 0);
                const m = data.metricas || { llamadas: 0, llamadasPct: 0, alumnos: 0, alumnosPct: 0 };

                container.innerHTML = `
                    <div class="mb-6 bg-white rounded-xl shadow-md p-6 flex flex-col items-center justify-center text-center border-t-4 border-blue-600 relative overflow-hidden">
                         <div class="absolute top-0 right-0 p-2 opacity-10">
                            <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                         </div>
                         <h3 class="font-bold text-gray-500 text-sm uppercase tracking-wider mb-1">Calificaci√≥n General</h3>
                         <p class="text-7xl font-extrabold text-blue-600 my-2 tracking-tight">${calificacionGeneral.toFixed(2)}</p>
                         <div class="w-full max-w-md bg-gray-200 rounded-full h-3 mt-2">
                             <div class="progress-bar h-3 rounded-full shadow-inner" style="width: ${calificacionGeneral * 10}%"></div>
                         </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center justify-center hover:shadow-md transition-shadow">
                            <span class="text-2xl mb-1">üìû</span>
                            <span class="text-2xl font-bold text-slate-700">${m.llamadas}</span>
                            <span class="text-xs text-slate-500 uppercase tracking-wide text-center">Llamadas Realizadas</span>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-blue-500 flex flex-col items-center justify-center relative overflow-hidden hover:shadow-md transition-shadow">
                            <span class="text-2xl font-bold text-blue-600 z-10">${m.llamadasPct}%</span>
                            <span class="text-xs text-slate-500 uppercase tracking-wide z-10 text-center">Cumplimiento Llamadas</span>
                            <div class="absolute bottom-0 left-0 h-1.5 bg-blue-100 w-full"><div class="h-full bg-blue-500" style="width: ${Math.min(m.llamadasPct, 100)}%"></div></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center justify-center hover:shadow-md transition-shadow">
                            <span class="text-2xl mb-1">üéì</span>
                            <span class="text-2xl font-bold text-slate-700">${m.alumnos}</span>
                            <span class="text-xs text-slate-500 uppercase tracking-wide text-center">Alumnos Contactados</span>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-orange-500 flex flex-col items-center justify-center relative overflow-hidden hover:shadow-md transition-shadow">
                            <span class="text-2xl font-bold text-orange-600 z-10">${m.alumnosPct}%</span>
                            <span class="text-xs text-slate-500 uppercase tracking-wide z-10 text-center">Cumplimiento Alumnos</span>
                            <div class="absolute bottom-0 left-0 h-1.5 bg-orange-100 w-full"><div class="h-full bg-orange-500" style="width: ${Math.min(m.alumnosPct, 100)}%"></div></div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-slate-400 mb-8 bg-gradient-to-r from-white to-slate-50">
                         <h3 class="font-bold text-lg mb-2 text-slate-800 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
                            Feedback General del Supervisor
                         </h3>
                         <p class="text-gray-700 leading-relaxed">${data.comentariosGenerales || 'Sin comentarios generales disponibles.'}</p>
                    </div>

                    <div class="space-y-6">${categoriesHTML}</div>
                    
                    <div class="mt-8 text-center flex justify-center space-x-4">
                        <a href="${data.enlaceDetalles || '#'}" target="_blank" class="btn-primary inline-flex items-center text-white font-semibold py-3 px-6 rounded-lg shadow hover:shadow-lg transition-transform hover:-translate-y-1">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            Ver Detalles (PDF/Drive)
                        </a>
                    </div>
                `;

            } catch (e) {
                console.error(e);
                container.innerHTML = `<div class="text-red-500 p-4">Error: ${e.message}</div>`;
            }
        }
        
        // Helper para colores de score
        function getColorForScore(score) {
            if (score >= 90) return 'text-green-600';
            if (score >= 80) return 'text-yellow-600';
            return 'text-red-600';
        }
        
        // ======================= HELPERS Y UTILIDADES =======================
        
        async function loadUsersCache() {
            usersCache = {};
            supervisorsCache = [];
            const querySnapshot = await getDocs(collection(db, "users"));
            querySnapshot.forEach((doc) => {
                usersCache[doc.id] = { id: doc.id, ...doc.data() };
                if (doc.data().rol === 'supervisor') {
                    supervisorsCache.push({ id: doc.id, ...doc.data() });
                }
            });
        }

        function showConfirmModal(title, text, onConfirm) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalText').textContent = text;
            const confirmBtn = document.getElementById('confirmOkBtn');
            const cancelBtn = document.getElementById('confirmCancelBtn');
            
            const newConfirmBtn = confirmBtn.cloneNode(true); 
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                document.getElementById('confirmModal').classList.add('hidden');
            });
            cancelBtn.onclick = () => document.getElementById('confirmModal').classList.add('hidden');

            document.getElementById('confirmModal').classList.remove('hidden');
        }
        
        function showSyncIndicator(elementId) {
            const indicator = document.getElementById(elementId);
            if (indicator) {
                indicator.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-yellow-500 animate-ping absolute"></div>
                    <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                    <span class="ml-1">Guardando...</span>`;
                setTimeout(() => {
                    indicator.innerHTML = `
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span>Sincronizado</span>`;
                }, 1500);
            }
        }

        async function loadAvailablePeriods() {
            const configDoc = await getDoc(doc(db, "system", "config"));
            if (configDoc.exists()) {
                const data = configDoc.data();
                availablePeriods.years = data.availableYears || [new Date().getFullYear().toString()];
                availablePeriods.months = data.availableMonths || ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            }
        }






        // ======================= GESTI√ìN DE PLANTILLAS (NUEVO) =======================

        // Carga las plantillas del supervisor desde Firestore
        async function loadTemplates() {
            const container = document.getElementById('templatesListContainer');
            if(!container) return; // Validaci√≥n de seguridad
            container.innerHTML = '<div class="skeleton h-12 w-full"></div>';
            
            templatesCache = [];
            // Consultamos la colecci√≥n 'templates' creada por el usuario actual
            const q = query(collection(db, "templates"), where("supervisorId", "==", currentUser.id));
            const snapshot = await getDocs(q);
            
            snapshot.forEach(doc => {
                templatesCache.push({ id: doc.id, ...doc.data() });
            });

            // Ordenar alfab√©ticamente
            templatesCache.sort((a, b) => a.nombre.localeCompare(b.nombre));
            renderTemplatesList();
        }
        
        // Renderiza la lista en el panel de Supervisor
        function renderTemplatesList() {
            const container = document.getElementById('templatesListContainer');
            container.innerHTML = '';

            if (templatesCache.length === 0) {
                container.innerHTML = `<div class="text-center p-4 bg-gray-50 rounded-lg border border-dashed border-gray-300 text-gray-500 text-sm">No tienes plantillas.<br><button onclick="openTemplateModal()" class="text-blue-600 font-bold underline mt-1">Crear la primera</button></div>`;
                return;
            }

            templatesCache.forEach(tpl => {
                const div = document.createElement('div');
                div.className = `flex justify-between items-center p-3 border border-gray-200 rounded-lg hover:border-blue-300 bg-white transition-colors`;
                div.innerHTML = `
                    <div>
                        <div class="font-bold text-gray-700">${tpl.nombre}</div>
                        <div class="text-xs text-gray-500 mt-0.5">
                            ${tpl.categorias?.length || 0} Categor√≠as ‚Ä¢ ${tpl.createdAt?.toDate().toLocaleDateString() || 'Reciente'}
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="openTemplateModal('${tpl.id}')" class="text-xs text-indigo-600 font-bold hover:text-indigo-800 p-1">Editar</button>
                        <button onclick="deleteTemplate('${tpl.id}')" class="text-xs text-red-500 font-bold hover:text-red-700 p-1">Eliminar</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Variable para saber qu√© plantilla estamos editando
        let activeTemplateId = null;
        
        // Abre el modal para Crear/Editar una Plantilla
        async function openTemplateModal(templateId = null) {
            // Limpiamos la UI de categor√≠as por si acaso
            document.getElementById('categoriesContainer').innerHTML = '';
        
            if (templateId) {
                // MODO EDICI√ìN: Cargamos la plantilla existente
                activeTemplateId = templateId;
                const tpl = templatesCache.find(t => t.id === templateId);
                
                // Renderizamos sus categor√≠as en el panel derecho (reutilizando tu contenedor existente)
                setActiveTemplate(templateId);
                
                // Scroll hacia el panel de categor√≠as
                document.getElementById('categoriesContainer').scrollIntoView({ behavior: 'smooth' });
                alert(`Editando plantilla: "${tpl.nombre}".\nUsa el bot√≥n "A√±adir Categor√≠a" para modificarla.`);
                
            } else {
                // CREAR NUEVA
                const name = prompt("Nombre de la nueva plantilla (ej. Asesores Senior 2026):");
                if (!name) return;
                
                try {
                    const newRef = await addDoc(collection(db, "templates"), {
                        supervisorId: currentUser.id,
                        nombre: name,
                        categorias: [],
                        createdAt: serverTimestamp()
                    });
                    
                    await loadTemplates();
                    // Seleccionamos la nueva plantilla autom√°ticamente
                    activeTemplateId = newRef.id;
                    setActiveTemplate(newRef.id);
                    alert(`Plantilla "${name}" creada. Ahora a√±ade categor√≠as.`);
                } catch (e) {
                    console.error(e);
                    alert("Error al crear plantilla.");
                }
            }
        }
        
        // Muestra las categor√≠as de la plantilla seleccionada en el panel derecho
        async function setActiveTemplate(tplId) {
            const tpl = templatesCache.find(t => t.id === tplId);
            if (!tpl) return;
        
            // Actualizar t√≠tulo visualmente
            const titleHeader = document.querySelector('#categoriesContainer').parentElement.querySelector('h2');
            if(titleHeader) titleHeader.innerHTML = `üìù Editando: <span class="text-blue-600">${tpl.nombre}</span>`;
        
            // Renderizar categor√≠as (reutilizando l√≥gica visual)
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';
            
            const cats = normalizeCategories(tpl.categorias || []);
            
            if (cats.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center py-4">Plantilla vac√≠a. A√±ade categor√≠as.</p>`;
            } else {
                cats.forEach((cat, index) => {
                    // (Aqu√≠ va tu l√≥gica de renderizado de tarjeta de categor√≠a)
                    // ... Para simplificar, insertamos una versi√≥n b√°sica:
                    const div = document.createElement('div');
                    div.className = 'p-4 border rounded-lg bg-slate-50 relative mb-3';
                    
                    let groupsHtml = '';
                    cat.grupos.forEach(g => {
                        groupsHtml += `<li class="text-sm text-gray-600 ml-4 list-disc">${g.nombre} (${g.ponderacion}%)</li>`;
                    });

                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold">${cat.nombre} <span class="text-sm font-normal text-gray-500">(${cat.ponderacion}%)</span></h4>
                            <div>
                                <button onclick="openCategoryModal(${index})" class="text-indigo-600 text-sm mr-2 font-medium">Editar</button>
                                <button onclick="deleteCategory(${index})" class="text-red-600 text-sm font-medium">Eliminar</button>
                            </div>
                        </div>
                        <ul class="mt-2 space-y-1">${groupsHtml}</ul>
                    `;
                    container.appendChild(div);
                });
            }
            // Importante: llamar a updatePonderacionTotal si existe
            if(typeof updatePonderacionTotal === 'function') updatePonderacionTotal();
        }
        
        async function deleteTemplate(tplId) {
            if(!confirm("¬øEliminar esta plantilla? Las evaluaciones pasadas NO se ver√°n afectadas, pero no podr√°s crear nuevas con ella.")) return;
            
            await deleteDoc(doc(db, "templates", tplId));
            
            if(activeTemplateId === tplId) {
                activeTemplateId = null;
                document.getElementById('categoriesContainer').innerHTML = '<p class="text-gray-400 text-center py-4">Selecciona una plantilla para ver sus categor√≠as.</p>';
                const titleHeader = document.querySelector('#categoriesContainer').parentElement.querySelector('h2');
                if(titleHeader) titleHeader.textContent = `üìù Plantilla de Evaluaci√≥n`;
            }
            await loadTemplates();
        }
        
        function toggleCriteria(button) {
            const criteriaContent = button.nextElementSibling;
            const icon = button.querySelector('svg');
            const buttonText = button.querySelector('span');
            
            const isOpen = criteriaContent.classList.toggle('open');
            icon.classList.toggle('rotated', isOpen);
            buttonText.textContent = isOpen ? 'Ocultar Criterios' : 'Ver Criterios';
        }

        async function initializeDataIfNeeded() {
            const configRef = doc(db, "system", "config");
            const configDoc = await getDoc(configRef);

            if (!configDoc.exists()) {
                console.log("No initial config found. Creating defaults...");
                const batch = writeBatch(db);
                
                batch.set(doc(db, "users", "superadmin"), {
                    nombre: "Super Administrador",
                    password: "cnci2025",
                    rol: "superadmin"
                });

                batch.set(configRef, {
                    loginTitle: "Evaluaci√≥n Modular",
                    loginSubtitle: "Departamento de Servicios Estudiantiles",
                    availableYears: ["2026", "2025"],
                    availableMonths: ["M1", "M2", "M3", "M4", "M5", "M6", "M7", "M8", "M9", "M10", "M11", "M12"]
                });
                
                await batch.commit();
                console.log("Default config and SuperAdmin created.");
            }
        }
        
        // ======================= L√ìGICA DE IMPORTACI√ìN/EXPORTACI√ìN CSV =======================
        function openImportModal(type) {
            document.getElementById('importDataType').value = type;
            document.getElementById('importForm').reset();
            const title = type === 'users' ? 'Importar Usuarios' : type === 'badges' ? 'Importar Insignias' : 'Importar Evaluaciones';
            document.getElementById('importExportTitle').textContent = title;
            document.getElementById('importExportModal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('importExportModal').classList.add('hidden');
        }

        async function exportUsersToCSV() {
            const usersSnapshot = await getDocs(collection(db, "users"));
            let csvContent = "username,nombre,rol,password,supervisorAsignado\n";
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const row = [doc.id, `"${user.nombre}"`, user.rol, user.password, user.supervisorAsignado || ''].join(',');
                csvContent += row + "\n";
            });
            downloadCSV(csvContent, 'usuarios_respaldo.csv');
        }

        async function exportSupervisorEvaluationsToCSV() {
            await loadUsersCache();
            const templateDoc = await getDoc(doc(db, "evaluation_templates", currentUser.id));
            if (!templateDoc.exists()) {
                alert("No se puede exportar porque no tienes una plantilla de evaluaci√≥n definida.");
                return;
            }
            
            // 1. NORMALIZAMOS para asegurar que leemos la estructura de grupos
            const template = normalizeCategories(templateDoc.data().categorias || []);
            
            // 2. Construir Encabezados
            let headers = ["evalId", "asesorId", "asesorNombre", "mes", "a√±o", "calificacionGeneral", "metaLlamadas", "comentariosGenerales", "enlaceDetalles", "enlacePlanTrabajo", "textoPlanTrabajo"];
            
            template.forEach(cat => {
                cat.grupos.forEach(grupo => {
                    grupo.criterios.forEach(crit => {
                        const cleanCrit = crit.replace(/"/g, '""');
                        // Formato de cabecera: "Categoria - Grupo - Criterio"
                        headers.push(`"${cat.nombre} - ${grupo.nombre} - ${cleanCrit}"`);
                    });
                });
                // Los comentarios siguen siendo por categor√≠a
                headers.push(`"${cat.nombre}_ComentarioCalidad"`, `"${cat.nombre}_ComentarioSupervision"`);
            });
            
            const q = query(collection(db, "evaluations"), where("supervisorId", "==", currentUser.id));
            const evaluationsSnapshot = await getDocs(q);

            let csvContent = headers.join(',') + '\n';

            // 3. Construir Filas
            evaluationsSnapshot.forEach(doc => {
                const e = doc.data();
                const asesorNombre = usersCache[e.asesorId]?.nombre || 'N/A';
                
                let row = [
                    doc.id, e.asesorId, `"${asesorNombre}"`, e.month, e.year,
                    e.calificacionGeneral || '', e.metaLlamadas || '',
                    `"${(e.comentariosGenerales || '').replace(/"/g, '""')}"`,
                    `"${e.enlaceDetalles || ''}"`,
                    `"${e.enlacePlanTrabajo || ''}"`,
                    `"${(e.textoPlanTrabajo || '').replace(/"/g, '""')}"`
                ];

                template.forEach(cat => {
                    const catData = e.categoriasEvaluadas ? e.categoriasEvaluadas[cat.nombre] || {} : {};
                    
                    cat.grupos.forEach(grupo => {
                        grupo.criterios.forEach(crit => {
                            // Buscamos el puntaje del criterio (guardado plano en el objeto de evaluaci√≥n)
                            const score = catData.criterios ? catData.criterios[crit] || '' : '';
                            row.push(score);
                        });
                    });

                    row.push(`"${(catData.comentarioCalidad || '').replace(/"/g, '""')}"`);
                    row.push(`"${(catData.comentarioSupervision || '').replace(/"/g, '""')}"`);
                });
                csvContent += row.join(',') + '\n';
            });

            downloadCSV(csvContent, `evaluaciones_${currentUser.id}_respaldo.csv`);
        }
        
        async function exportBadgesToCSV() {
            const badgesSnapshot = await getDocs(collection(db, "insignias"));
            let csvContent = "id,nombre,icono,descripcion,tipo,creadorId\n";
            badgesSnapshot.forEach(doc => {
                const badge = doc.data();
                const row = [doc.id, `"${badge.nombre}"`, `"${badge.icono}"`, `"${badge.descripcion}"`, badge.tipo, badge.creadorId || ''].join(',');
                csvContent += row + "\n";
            });
            downloadCSV(csvContent, 'insignias_respaldo.csv');
        }

        function downloadCSV(content, fileName) {
            const blob = new Blob(["\uFEFF" + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.getElementById('importForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('csvFileInput');
            if (fileInput.files.length === 0) {
                alert('Por favor, selecciona un archivo CSV.');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(event) {
                const csvData = event.target.result;
                const dataType = document.getElementById('importDataType').value;
                
                if (dataType === 'users') {
                    await importUsersFromCSV(csvData);
                } else if (dataType === 'evaluations') {
                    await importSupervisorEvaluationsFromCSV(csvData);
                } else if (dataType === 'badges') { 
                    await importBadgesFromCSV(csvData);
                }
            };
            
            reader.readAsText(file, "UTF-8");
        });

        async function importUsersFromCSV(csvData) {
            const overwrite = document.getElementById('overwriteDataCheckbox').checked;
            const lines = csvData.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('El archivo CSV est√° vac√≠o o solo contiene la cabecera.');
                return;
            }
            
            const headers = parseCSVLine(lines[0]);
            const batch = writeBatch(db);
            let operationsCount = 0;

            try {
            const cleanHeaders = headers.map(h => h.replace(/"/g, ''));

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                
                const record = cleanHeaders.reduce((obj, header, index) => {
                    obj[header] = values[index] || ''; 
                    return obj;
                }, {});

                    if (!record.username) continue;
                    const userRef = doc(db, "users", record.username);
                    const userData = {
                        nombre: record.nombre || '',
                        rol: record.rol || 'asesor',
                        password: record.password || '123',
                        supervisorAsignado: record.supervisorAsignado || null
                    };
                    
                    batch.set(userRef, userData, { merge: !overwrite });
                    operationsCount++;
                }
                await batch.commit();
                alert(`Se han procesado ${operationsCount} registros de usuarios.`);
                closeImportModal();
                await loadUsersCache();
                renderUsersTable();
            } catch (error) {
                console.error("Error al importar usuarios CSV:", error);
                alert("Error al importar el archivo de usuarios. Revisa la consola.");
            }
        }

        async function importSupervisorEvaluationsFromCSV(csvData) {
            const overwrite = document.getElementById('overwriteDataCheckbox').checked;
            const templateDoc = await getDoc(doc(db, "evaluation_templates", currentUser.id));
             if (!templateDoc.exists()) {
                alert("No se puede importar porque no tienes una plantilla de evaluaci√≥n definida.");
                return;
            }
            
            // 1. NORMALIZAR PLANTILLA
            const template = normalizeCategories(templateDoc.data().categorias || []);
            
            const lines = csvData.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('El archivo CSV de evaluaciones est√° vac√≠o o solo contiene la cabecera.');
                return;
            }

            // Usamos tu funci√≥n parseCSVLine para leer cabeceras complejas correctamente
            const headers = parseCSVLine(lines[0]); 
            const batch = writeBatch(db);
            let operationsCount = 0;

            try {
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    const record = headers.reduce((obj, header, index) => {
                        // Limpiamos comillas extra si las hubiera
                        obj[header.replace(/^"|"$/g, '')] = values[index] ? values[index].replace(/^"|"$/g, '') : '';
                        return obj;
                    }, {});

                    if (!record.evalId && !(record.asesorId && record.a√±o && record.mes)) continue;
                    
                    const evalId = record.evalId || `${record.asesorId}_${record.a√±o}_${record.mes}`;
                    const evalRef = doc(db, "evaluations", evalId);

                    const evalData = {
                        asesorId: record.asesorId, supervisorId: currentUser.id, month: record.mes, year: record.a√±o,
                        calificacionGeneral: record.calificacionGeneral || '', metaLlamadas: record.metaLlamadas || '',
                        comentariosGenerales: record.comentariosGenerales || '', enlaceDetalles: record.enlaceDetalles || '',
                        enlacePlanTrabajo: record.enlacePlanTrabajo || '', textoPlanTrabajo: record.textoPlanTrabajo || '',
                        categoriasEvaluadas: {}
                    };

                    let finalWeightedScore = 0;

                    // 2. Reconstruir datos usando la estructura de GRUPOS
                    template.forEach(cat => {
                        const catName = cat.nombre;
                        const catData = { criterios: {}, puntaje: 0, comentarioCalidad: '', comentarioSupervision: '' };
                        
                        let catTotalWeightedScore = 0;

                        cat.grupos.forEach(grupo => {
                            let grupoSum = 0;
                            let grupoCount = 0;

                            grupo.criterios.forEach(crit => {
                                // Reconstruimos la clave del CSV: "Categoria - Grupo - Criterio"
                                const csvKey = `${cat.nombre} - ${grupo.nombre} - ${crit}`;
                                // Intentamos leer el valor
                                const val = record[csvKey]; 
                                
                                if (val && val !== '') {
                                    const score = parseFloat(val);
                                    if (!isNaN(score)) {
                                        catData.criterios[crit] = score;
                                        grupoSum += score;
                                        grupoCount++;
                                    }
                                }
                            });

                            // Calcular aporte del grupo (L√≥gica V2)
                            if (grupoCount > 0) {
                                const grupoAvg = grupoSum / grupoCount;
                                const grupoContribution = grupoAvg * (parseFloat(grupo.ponderacion || 0) / 100);
                                catTotalWeightedScore += grupoContribution;
                            }
                        });
                        
                        // Asignar puntaje calculado y comentarios
                        catData.puntaje = catTotalWeightedScore.toFixed(2);
                        catData.comentarioCalidad = record[`${catName}_ComentarioCalidad`] || '';
                        catData.comentarioSupervision = record[`${catName}_ComentarioSupervision`] || '';
                        
                        evalData.categoriasEvaluadas[catName] = catData;

                        // Sumar a la calificaci√≥n general
                        finalWeightedScore += catTotalWeightedScore * (parseFloat(cat.ponderacion || 0) / 100);
                    });

                    // Si el CSV no tra√≠a calificaci√≥n general, la calculamos nosotros
                    if (!evalData.calificacionGeneral || evalData.calificacionGeneral === '') {
                        evalData.calificacionGeneral = finalWeightedScore.toFixed(2);
                    }

                    batch.set(evalRef, evalData, { merge: !overwrite });
                    operationsCount++;
                }

                await batch.commit();
                alert(`Se han procesado ${operationsCount} registros de evaluaciones.`);
                closeImportModal();

            } catch(error) {
                console.error("Error al importar evaluaciones CSV:", error);
                alert("Error al importar: " + error.message);
            }
        }
        
        async function importBadgesFromCSV(csvData) {
            const overwrite = document.getElementById('overwriteDataCheckbox').checked;
            const lines = csvData.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('El archivo CSV de insignias est√° vac√≠o o solo contiene la cabecera.');
                return;
            }

            // MEJORA: Usar parseCSVLine en lugar de split(',') para mayor seguridad
            const headers = parseCSVLine(lines[0]); 
            const batch = writeBatch(db);
            let operationsCount = 0;

            try {
                // Limpiamos comillas de las cabeceras
                const cleanHeaders = headers.map(h => h.replace(/"/g, ''));

                for (let i = 1; i < lines.length; i++) {
                    // MEJORA: Usar parseCSVLine para los valores tambi√©n
                    const values = parseCSVLine(lines[i]); 
                    
                    const record = cleanHeaders.reduce((obj, header, index) => {
                        // Limpiamos comillas de los valores
                        obj[header] = values[index] ? values[index].replace(/^"|"$/g, '') : '';
                        return obj;
                    }, {});

                    if (!record.id) continue;
                    
                    const badgeRef = doc(db, "insignias", record.id);
                    const badgeData = {
                        nombre: record.nombre || '',
                        icono: record.icono || '',
                        descripcion: record.descripcion || '',
                        tipo: record.tipo || 'global',
                        creadorId: record.creadorId || null
                    };
                    
                    batch.set(badgeRef, badgeData, { merge: !overwrite });
                    operationsCount++;
                }
                await batch.commit();
                alert(`Se han procesado ${operationsCount} registros de insignias.`);
                closeImportModal();
                await loadBadgesCache();
                if (typeof renderGlobalBadgesTable === 'function') renderGlobalBadgesTable(); // Validaci√≥n extra por seguridad
            } catch (error) {
                console.error("Error al importar insignias CSV:", error);
                alert("Error al importar el archivo de insignias. Revisa la consola.");
            }
        }


        // ======================= L√ìGICA DE C√ÅLCULO DE PUNTAJES =======================
        
        async function calculateWeightedScore() {
            const templateDoc = await getDoc(doc(db, "evaluation_templates", currentUser.id));
            if (!templateDoc.exists()) return;
            
            // 1. Obtenemos datos y normalizamos para asegurar estructura de grupos
            let rawCategories = templateDoc.data().categorias || [];
            const templateCategories = normalizeCategories(rawCategories);
            
            let finalWeightedScore = 0;

            // 2. Iteramos Nivel CATEGOR√çA
            templateCategories.forEach(cat => {
                const catPonderacion = parseFloat(cat.ponderacion) || 0;
                let catTotalScore = 0; // Puntaje acumulado de la categor√≠a (suma de grupos ponderados)

                // 3. Iteramos Nivel GRUPO
                cat.grupos.forEach(grupo => {
                    const grupoPonderacion = parseFloat(grupo.ponderacion) || 0;
                    
                    // Buscamos los inputs que pertenecen a este Grupo Espec√≠fico
                    // NOTA: En el paso 2 de implementaci√≥n (pr√≥xima interacci√≥n) actualizaremos el HTML del modal
                    // para incluir data-group. Por ahora, buscamos por criterio para mantener compatibilidad V1.
                    
                    let grupoSum = 0;
                    let grupoCount = 0;

                    grupo.criterios.forEach(critName => {
                        // Selector robusto: Intenta buscar por categor√≠a Y criterio.
                        const input = document.querySelector(`#evaluationModal input[data-category="${cat.nombre}"][data-criterion="${critName}"]`);
                        
                        if (input && input.value !== '') {
                            const score = parseFloat(input.value);
                            if (!isNaN(score) && score >= 0 && score <= 10) {
                                grupoSum += score;
                                grupoCount++;
                            }
                        }
                    });

                    // 4. C√°lculo Promedio del Grupo (Nivel 2)
                    if (grupoCount > 0) {
                        const grupoAverage = grupoSum / grupoCount; // Promedio simple (0-10)
                        
                        // 5. Contribuci√≥n del Grupo a la Categor√≠a (Nivel 3)
                        // F√≥rmula: (PromedioGrupo * (PesoGrupo / 100))
                        const grupoContribution = grupoAverage * (grupoPonderacion / 100);
                        catTotalScore += grupoContribution;
                    }
                });

                // 6. Contribuci√≥n de la Categor√≠a a la General (Nivel 4)
                // F√≥rmula: (PuntajeCategoria * (PesoCategoria / 100))
                // Nota: catTotalScore ya est√° en escala 0-10 ponderada por sus grupos.
                const catContribution = catTotalScore * (catPonderacion / 100);
                
                finalWeightedScore += catContribution;
            });

            const finalScoreOutOf10 = finalWeightedScore.toFixed(2); // Cambiado a 2 decimales seg√∫n requerimiento
            const scoreInput = document.getElementById('evalGeneralScore');
            if (scoreInput) {
                scoreInput.value = finalScoreOutOf10;
            }
        }

        // ======================= NUEVAS FUNCIONES PARA GR√ÅFICOS =======================

        function setupSupervisorChartSelectors() {
            const monthSelect = document.getElementById('supervisorMonthSelector');
            const yearSelect = document.getElementById('supervisorYearSelector');
            const currentMonthName = new Date().toLocaleString('es-ES', { month: 'long' });
            monthSelect.innerHTML = availablePeriods.months.map(m => `<option value="${m}" ${m.toLowerCase() === currentMonthName.toLowerCase() ? 'selected' : ''}>${m}</option>`).join('');
            yearSelect.innerHTML = availablePeriods.years.map(y => `<option value="${y}">${y}</option>`).join('');
            monthSelect.addEventListener('change', loadSupervisorCharts);
            yearSelect.addEventListener('change', loadSupervisorCharts);
        }
        

        
        
        
        
        async function loadSupervisorCharts() {
            const month = document.getElementById('supervisorMonthSelector').value;
            const year = document.getElementById('supervisorYearSelector').value;
            const q = query(collection(db, "evaluations"), where("supervisorId", "==", currentUser.id), where("year", "==", year), where("month", "==", month));
            const querySnapshot = await getDocs(q);
            
            // 1. Creamos un array temporal para almacenar los objetos completos
            const rawData = [];

            const supervisorAsesorIds = Object.values(usersCache)
                .filter(u => u.supervisorAsignado === currentUser.id)
                .map(u => u.id);

            querySnapshot.forEach(doc => {
                const evalData = doc.data();
                if (supervisorAsesorIds.includes(evalData.asesorId)) {
                    const asesorNombre = usersCache[evalData.asesorId]?.nombre || evalData.asesorId;
                    // Guardamos nombre y puntaje juntos
                    rawData.push({
                        nombre: asesorNombre,
                        puntaje: parseFloat(evalData.calificacionGeneral) || 0
                    });
                }
            });

            // 2. ORDENAMOS ALFAB√âTICAMENTE POR NOMBRE (La mejora solicitada)
            rawData.sort((a, b) => a.nombre.localeCompare(b.nombre));

            // 3. Separamos en los arrays que necesita Chart.js
            const labels = rawData.map(item => item.nombre);
            const data = rawData.map(item => item.puntaje);
            
            const ctx = document.getElementById('supervisorChart').getContext('2d');
            if (supervisorChart) {
                supervisorChart.destroy();
            }
            supervisorChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Calificaci√≥n General',
                        data: data,
                        backgroundColor: 'rgba(255, 133, 0, 0.6)',
                        borderColor: 'rgba(255, 133, 0, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 10 } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        function setupSuperAdminChartSelectors() {
            const monthSelect = document.getElementById('superAdminMonthSelector');
            const yearSelect = document.getElementById('superAdminYearSelector');
            const currentMonthName = new Date().toLocaleString('es-ES', { month: 'long' });
            monthSelect.innerHTML = availablePeriods.months.map(m => `<option value="${m}" ${m.toLowerCase() === currentMonthName.toLowerCase() ? 'selected' : ''}>${m}</option>`).join('');
            yearSelect.innerHTML = availablePeriods.years.map(y => `<option value="${y}">${y}</option>`).join('');
            monthSelect.addEventListener('change', loadSuperAdminCharts);
            yearSelect.addEventListener('change', loadSuperAdminCharts);
        }

        async function loadSuperAdminCharts() {
            const month = document.getElementById('superAdminMonthSelector').value;
            const year = document.getElementById('superAdminYearSelector').value;
            const q = query(collection(db, "evaluations"), where("year", "==", year), where("month", "==", month));
            const querySnapshot = await getDocs(q);
            
            const supervisorData = {}; // { supervisorId: { totalScore: X, count: Y } }
            
            querySnapshot.forEach(doc => {
                const evalData = doc.data();
                const supId = evalData.supervisorId;
                if (!supId) return;

                if (!supervisorData[supId]) {
                    supervisorData[supId] = { totalScore: 0, count: 0 };
                }
                supervisorData[supId].totalScore += parseFloat(evalData.calificacionGeneral) || 0;
                supervisorData[supId].count++;
            });

            const labels = [];
            const data = [];
            for (const supId in supervisorData) {
                const supNombre = usersCache[supId]?.nombre || supId;
                const avg = supervisorData[supId].count > 0 ? supervisorData[supId].totalScore / supervisorData[supId].count : 0;
                labels.push(supNombre);
                data.push(avg.toFixed(2));
            }
            
            const ctx = document.getElementById('superAdminChart').getContext('2d');
            if (superAdminChart) {
                superAdminChart.destroy();
            }
            superAdminChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Calificaci√≥n Promedio del Equipo',
                        data: data,
                        backgroundColor: 'rgba(42, 106, 255, 0.6)',
                        borderColor: 'rgba(42, 106, 255, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 10 } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        async function renderAsesorCharts() {
            const container = document.getElementById('tendencias-tab');
            const year = document.getElementById('yearSelector').value;
            const q = query(collection(db, "evaluations"), where("asesorId", "==", currentUser.id), where("year", "==", year));
            const querySnapshot = await getDocs(q);

            const monthlyScores = {}; // { Enero: 8.5, Febrero: 9.0 ... }
            querySnapshot.forEach(doc => {
                const evalData = doc.data();
                monthlyScores[evalData.month] = parseFloat(evalData.calificacionGeneral) || 0;
            });

            const labels = availablePeriods.months;
            const data = labels.map(month => monthlyScores[month] || null);

            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-md p-6 border-t-4 border-blue-500">
                     <h3 class="font-bold text-xl mb-4">üìà Mi Progreso Anual</h3>
                     <div class="relative h-80">
                        <canvas id="asesorChart"></canvas>
                     </div>
                </div>
            `;
            
            const ctx = document.getElementById('asesorChart').getContext('2d');
            if (asesorChart) {
                asesorChart.destroy();
            }
            asesorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Calificaci√≥n General',
                        data: data,
                        borderColor: 'rgba(42, 106, 255, 1)',
                        backgroundColor: 'rgba(42, 106, 255, 0.1)',
                        fill: true,
                        tension: 0.3,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 10 } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // ======================= NUEVAS FUNCIONES PARA INSIGNIAS =======================
        
        async function loadBadgesCache() {
            badgesCache = {};
            const querySnapshot = await getDocs(collection(db, "insignias"));
            querySnapshot.forEach(doc => {
                badgesCache[doc.id] = { id: doc.id, ...doc.data() };
            });
        }

        function renderGlobalBadgesTable() {
            const tbody = document.getElementById('globalBadgesTableBody');
            tbody.innerHTML = '';
            const globalBadges = Object.values(badgesCache).filter(b => b.tipo === 'global');
            if (globalBadges.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500 py-3">No hay insignias globales.</td></tr>`;
            } else {
                globalBadges.forEach(badge => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-2 text-2xl">${badge.icono}</td>
                        <td class="px-4 py-2 font-medium">${badge.nombre}</td>
                        <td class="px-4 py-2">
                            <button onclick="openBadgeModal('${badge.id}')" class="text-indigo-600 hover:text-indigo-900 text-sm mr-2">Editar</button>
                            <button onclick="deleteBadge('${badge.id}')" class="text-red-600 hover:text-red-900 text-sm">Eliminar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }
        
        function renderSupervisorBadgesTable() {
            const tbody = document.getElementById('supervisorBadgesTableBody');
            tbody.innerHTML = '';
            const supervisorBadges = Object.values(badgesCache).filter(b => b.creadorId === currentUser.id);
            if (supervisorBadges.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500 py-3">No has creado insignias.</td></tr>`;
            } else {
                supervisorBadges.forEach(badge => {
                    const tr = document.createElement('tr');
                    tr.className = 'transition-colors';
                    tr.innerHTML = `
                        <td class="px-4 py-2 text-2xl">${badge.icono}</td>
                        <td class="px-4 py-2 font-medium">${badge.nombre}</td>
                        <td class="px-4 py-2">
                             <button onclick="openBadgeModal('${badge.id}', false)" class="text-indigo-600 hover:text-indigo-900 text-sm mr-2">Editar</button>
                             <button onclick="deleteBadge('${badge.id}')" class="text-red-600 hover:text-red-900 text-sm">Eliminar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function openBadgeModal(badgeId = null, isGlobal = true) {
            document.getElementById('badgeForm').reset();
            document.getElementById('badgeId').value = badgeId || '';
            document.getElementById('isGlobalBadge').value = isGlobal;

            if (badgeId) {
                const badge = badgesCache[badgeId];
                document.getElementById('badgeModalTitle').textContent = 'Editar Insignia';
                document.getElementById('badgeName').value = badge.nombre;
                document.getElementById('badgeIcon').value = badge.icono;
                document.getElementById('badgeDescription').value = badge.descripcion;
            } else {
                document.getElementById('badgeModalTitle').textContent = isGlobal ? 'A√±adir Insignia Global' : 'A√±adir Mi Insignia';
            }
            document.getElementById('badgeModal').classList.remove('hidden');
        }

        function closeBadgeModal() {
            document.getElementById('badgeModal').classList.add('hidden');
        }
        
        document.getElementById('badgeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const badgeId = document.getElementById('badgeId').value;
            const isGlobal = document.getElementById('isGlobalBadge').value === 'true';

            const badgeData = {
                nombre: document.getElementById('badgeName').value,
                icono: document.getElementById('badgeIcon').value,
                descripcion: document.getElementById('badgeDescription').value,
                tipo: isGlobal ? 'global' : 'supervisor',
                creadorId: isGlobal ? null : currentUser.id,
                updatedAt: serverTimestamp()
            };

            if (badgeId) {
                await setDoc(doc(db, "insignias", badgeId), badgeData, { merge: true });
            } else {
                badgeData.createdAt = serverTimestamp();
                await addDoc(collection(db, "insignias"), badgeData);
            }

            await loadBadgesCache();
            if (isGlobal) {
                renderGlobalBadgesTable();
                showSyncIndicator('superAdminSyncIndicator');
            } else {
                renderSupervisorBadgesTable();
                 showSyncIndicator('supervisorSyncIndicator');
            }
            closeBadgeModal();
        });

        async function deleteBadge(badgeId) {
            showConfirmModal('Eliminar Insignia', '¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.', async () => {
                await deleteDoc(doc(db, "insignias", badgeId));
                await loadBadgesCache();
                if (currentUser.rol === 'superadmin') {
                    renderGlobalBadgesTable();
                    showSyncIndicator('superAdminSyncIndicator');
                } else {
                    renderSupervisorBadgesTable();
                    showSyncIndicator('supervisorSyncIndicator');
                }
            });
        }
        
        async function openGrantBadgeModal() {
            const listContainer = document.getElementById('grantBadgeList');
            listContainer.innerHTML = '';

            const availableBadges = Object.values(badgesCache).filter(b => b.tipo === 'global' || b.creadorId === currentUser.id);
            const existingBadges = currentEvaluationBadges; 

            if (availableBadges.length === 0) {
                 listContainer.innerHTML = '<p class="text-gray-500">No hay insignias disponibles para otorgar.</p>';
            } else {
                const globalBadges = availableBadges.filter(b => b.tipo === 'global');
                const supervisorBadges = availableBadges.filter(b => b.creadorId === currentUser.id);

                if(globalBadges.length > 0){
                    listContainer.innerHTML += '<h4 class="font-bold text-gray-700 border-b pb-2 mb-2">üåê Insignias Globales</h4>';
                    globalBadges.forEach(badge => {
                        listContainer.innerHTML += createBadgeCheckbox(badge, existingBadges);
                    });
                }
                if(supervisorBadges.length > 0){
                    listContainer.innerHTML += '<h4 class="font-bold text-gray-700 border-b pb-2 mb-2 mt-4">üßë‚Äçüè´ Mis Insignias</h4>';
                    supervisorBadges.forEach(badge => {
                        listContainer.innerHTML += createBadgeCheckbox(badge, existingBadges);
                    });
                }
            }
            document.getElementById('grantBadgeModal').classList.remove('hidden');
        }

        function createBadgeCheckbox(badge, existingBadges) {
            const isChecked = existingBadges.includes(badge.id);
            return `
                <div class="flex items-start p-3 border rounded-lg hover:bg-gray-50">
                    <input type="checkbox" id="badge-check-${badge.id}" value="${badge.id}" class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded" ${isChecked ? 'checked' : ''}>
                    <label for="badge-check-${badge.id}" class="ml-3 flex-grow cursor-pointer">
                        <span class="text-3xl">${badge.icono}</span>
                        <span class="font-bold ml-2">${badge.nombre}</span>
                        <p class="text-sm text-gray-600">${badge.descripcion}</p>
                    </label>
                </div>
            `;
        }

        function closeGrantBadgeModal() {
            currentEvaluationBadges = [];
            document.querySelectorAll('#grantBadgeList input[type="checkbox"]:checked').forEach(checkbox => {
                currentEvaluationBadges.push(checkbox.value);
            });
            document.getElementById('grantBadgeModal').classList.add('hidden');
        }

        async function renderAsesorBadges() {
            const container = document.getElementById('insignias-tab');
            container.innerHTML = '<div class="skeleton h-64 w-full"></div>';

            const q = query(collection(db, "evaluations"), where("asesorId", "==", currentUser.id));
            const querySnapshot = await getDocs(q);

            const earnedBadgeIds = new Set();
            const badgeHistory = []; 

            querySnapshot.forEach(doc => {
                const evalData = doc.data();
                const period = `${evalData.month} ${evalData.year}`;
                const supervisorName = usersCache[evalData.supervisorId]?.nombre || 'N/A';
                (evalData.insigniasOtorgadas || []).forEach(badgeId => {
                    earnedBadgeIds.add(badgeId);
                    const badgeInfo = badgesCache[badgeId];
                    if (badgeInfo) {
                        badgeHistory.push({
                            period: period,
                            badge: badgeInfo,
                            supervisor: supervisorName,
                            date: new Date(evalData.year, availablePeriods.months.indexOf(evalData.month))
                        });
                    }
                });
            });
            
            const earnedBadges = Array.from(earnedBadgeIds).map(id => badgesCache[id]).filter(Boolean);
            // A√±adimos validaci√≥n para asegurar que supervisorAsignado exista antes de comparar
            const supervisorId = currentUser.supervisorAsignado || '';
            const availableBadges = Object.values(badgesCache).filter(b => b.tipo === 'global' || (supervisorId && b.creadorId === supervisorId));

            let html = '<div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-orange-500">';
            html += '<h3 class="font-bold text-xl mb-4">üèÜ Mis Insignias Ganadas</h3>';
            if (earnedBadges.length > 0) {
                html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                earnedBadges.forEach(badge => {
                    const badgeType = badge.tipo === 'global' ? 'Global üåê' : 'Equipo üßë‚Äçüè´';
                    html += `
                        <div class="border p-4 rounded-lg flex items-start space-x-4">
                            <span class="text-4xl">${badge.icono}</span>
                            <div>
                                <h4 class="font-bold">${badge.nombre}</h4>
                                <p class="text-sm text-gray-600 mb-2">${badge.descripcion}</p>
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${badge.tipo === 'global' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}">${badgeType}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                 html += '<p class="text-gray-500">A√∫n no has ganado ninguna insignia. ¬°Sigue esforz√°ndote!</p>';
            }

            html += '<h3 class="font-bold text-xl mt-8 mb-4">üìú Historial de Reconocimientos</h3>';
            if (badgeHistory.length > 0) {
                badgeHistory.sort((a, b) => b.date - a.date);
                html += `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Per√≠odo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Insignia</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Otorgada por</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                badgeHistory.forEach(item => {
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${item.period}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 flex items-center">
                                <span class="text-2xl mr-2">${item.badge.icono}</span>
                                ${item.badge.nombre}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.supervisor}</td>
                        </tr>
                    `;
                });
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                html += '<p class="text-gray-500">No hay un historial de insignias todav√≠a.</p>';
            }

            html += '<h3 class="font-bold text-xl mt-8 mb-4">üîì Pr√≥ximas Insignias</h3>';
            const unearnedBadges = availableBadges.filter(b => !earnedBadgeIds.has(b.id));

            if (unearnedBadges.length > 0) {
                html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                unearnedBadges.forEach(badge => {
                    html += `
                        <div class="border p-4 rounded-lg flex items-start space-x-4 opacity-60">
                            <span class="text-4xl filter grayscale">${badge.icono}</span>
                            <div>
                                <h4 class="font-bold">${badge.nombre}</h4>
                                <p class="text-sm text-gray-600">${badge.descripcion}</p>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                 html += '<p class="text-gray-500">¬°Felicidades! Has conseguido todas las insignias disponibles.</p>';
            }

            html += '</div>';
            container.innerHTML = html;
        }
        // ======================= NUEVAS FUNCIONES DE L√ìGICA V2 (NORMALIZACI√ìN) =======================

        /**
         * Convierte estructuras antiguas (Solo criterios) a la nueva (Grupos > Criterios).
         * Garantiza que el sistema siempre trabaje con 'grupos', aunque la BD tenga datos viejos.
         */
        function normalizeCategories(categorias) {
            if (!Array.isArray(categorias)) return [];
            
            return categorias.map(cat => {
                // CASO V2: La categor√≠a ya tiene grupos definidos. Se retorna tal cual.
                if (cat.grupos && Array.isArray(cat.grupos) && cat.grupos.length > 0) {
                    return cat;
                }
                
                // CASO V1 (Retrocompatibilidad): Tiene criterios sueltos pero no grupos.
                // Creamos un "Grupo General" que vale el 100% de la categor√≠a y metemos los criterios ah√≠.
                return {
                    ...cat,
                    grupos: [{
                        nombre: 'General',
                        ponderacion: 100,
                        criterios: cat.criterios || []
                    }],
                    // Mantenemos la propiedad criterios vac√≠a o nula para evitar confusiones futuras
                    criterios: null 
                };
            });
        }
        // ======================= L√ìGICA DE EXPORTACI√ìN MASIVA AVANZADA =======================

        let selectedTreeData = {}; // Estructura para guardar selecci√≥n: { 'supId': ['asesorId1', 'asesorId2'] }

        function openMassExportModal() {
            const modal = document.getElementById('massExportModal');
            const treeContainer = document.getElementById('exportTreeContainer');
            const monthSelect = document.getElementById('massExportMonth');
            const yearSelect = document.getElementById('massExportYear');

            // 1. Llenar selectores de fecha
            yearSelect.innerHTML = '<option value="all">Todos los a√±os</option>' + availablePeriods.years.map(y => `<option value="${y}">${y}</option>`).join('');
            monthSelect.innerHTML = '<option value="all">Todos los meses</option>' + availablePeriods.months.map(m => `<option value="${m}">${m}</option>`).join('');

            // 2. Construir el √Årbol de Selecci√≥n
            treeContainer.innerHTML = '';
            
            if (supervisorsCache.length === 0) {
                treeContainer.innerHTML = '<div class="text-center p-4 text-gray-500">No hay supervisores registrados.</div>';
            } else {
                // Ordenar supervisores alfab√©ticamente
                const sortedSupervisors = [...supervisorsCache].sort((a, b) => a.nombre.localeCompare(b.nombre));

                sortedSupervisors.forEach(sup => {
                    // Obtener asesores de este supervisor
                    const teamMembers = Object.values(usersCache)
                        .filter(u => u.supervisorAsignado === sup.id)
                        .sort((a, b) => a.nombre.localeCompare(b.nombre));

                    // Crear bloque del supervisor (Padre)
                    const supBlock = document.createElement('div');
                    supBlock.className = 'mb-1';
                    
                    const headerHtml = `
                        <div class="flex items-center p-2 bg-white border border-gray-200 rounded hover:bg-gray-50 transition-colors">
                            <button type="button" onclick="toggleNode('${sup.id}')" class="mr-2 text-gray-400 hover:text-gray-600 focus:outline-none">
                                <svg id="icon-${sup.id}" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                            <input type="checkbox" id="check-${sup.id}" onchange="toggleSupervisor('${sup.id}')" class="supervisor-check h-4 w-4 text-blue-600 rounded border-gray-300 mr-2">
                            <label for="check-${sup.id}" class="flex-grow cursor-pointer select-none">
                                <span class="font-bold text-sm text-gray-700">${sup.nombre}</span>
                                <span class="text-xs text-gray-400 ml-1">(${teamMembers.length} asesores)</span>
                            </label>
                        </div>
                    `;

                    // Crear lista de asesores (Hijos) - Oculta por defecto
                    let childrenHtml = `<div id="node-${sup.id}" class="hidden ml-6 mt-1 space-y-1 border-l-2 border-gray-100 pl-2">`;
                    
                    if (teamMembers.length === 0) {
                        childrenHtml += `<div class="text-xs text-gray-400 italic py-1 pl-2">Sin asesores asignados</div>`;
                    } else {
                        teamMembers.forEach(asesor => {
                            childrenHtml += `
                                <div class="flex items-center p-1 hover:bg-blue-50 rounded">
                                    <input type="checkbox" value="${asesor.id}" data-supervisor="${sup.id}" onchange="updateParentState('${sup.id}')" class="asesor-check h-3 w-3 text-indigo-500 rounded border-gray-300 mr-2">
                                    <span class="text-sm text-gray-600">${asesor.nombre}</span>
                                </div>
                            `;
                        });
                    }
                    childrenHtml += `</div>`;

                    supBlock.innerHTML = headerHtml + childrenHtml;
                    treeContainer.appendChild(supBlock);
                });
            }
            
            updateSelectionCount();
            modal.classList.remove('hidden');
        }

        // ======================= L√ìGICA DE VISUALIZACI√ìN DE EVALUACI√ìN INDIVIDUAL =======================

        async function viewSingleEvaluationFromExport() {
            // 1. Validar selecci√≥n √∫nica
            const selectedChecks = document.querySelectorAll('.asesor-check:checked');
            
            if (selectedChecks.length !== 1) {
                alert("Para ver una evaluaci√≥n, por favor selecciona exactamente UN asesor.");
                return;
            }

            const asesorId = selectedChecks[0].value;
            const supervisorId = selectedChecks[0].dataset.supervisor;
            const month = document.getElementById('massExportMonth').value;
            const year = document.getElementById('massExportYear').value;

            if (month === 'all' || year === 'all') {
                alert("Para ver una evaluaci√≥n, debes seleccionar un Mes y A√±o espec√≠ficos (no 'Todos').");
                return;
            }

            // 2. Preparar Modal
            const modal = document.getElementById('readOnlyEvaluationModal');
            const content = document.getElementById('readOnlyContent');
            const title = document.getElementById('readOnlyModalTitle');
            const subtitle = document.getElementById('readOnlyModalSubtitle');
            
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div></div>';
            
            const asesorName = usersCache[asesorId]?.nombre || asesorId;
            title.textContent = `Evaluaci√≥n: ${asesorName}`;
            subtitle.textContent = `Periodo: ${month} ${year}`;

            try {
                // 3. Obtener Datos
                const evalId = `${asesorId}_${year}_${month}`;
                const evalDoc = await getDoc(doc(db, "evaluations", evalId));

                if (!evalDoc.exists()) {
                    content.innerHTML = `
                        <div class="text-center p-8 text-gray-500">
                            <p class="text-xl mb-2">ü§∑‚Äç‚ôÇÔ∏è</p>
                            <p class="font-bold">No se encontr√≥ evaluaci√≥n</p>
                            <p class="text-sm">El asesor no tiene evaluaci√≥n registrada para este periodo.</p>
                        </div>
                    `;
                    return;
                }

                const data = evalDoc.data();
                
                // 4. Obtener Plantilla del Supervisor (para estructura correcta)
                const templateDoc = await getDoc(doc(db, "evaluation_templates", supervisorId));
                const template = normalizeCategories(templateDoc.exists() ? templateDoc.data().categorias || [] : []);

                // 5. Renderizar Contenido (Reutilizando l√≥gica visual del dashboard)
                let html = '';

                // --- M√©tricas ---
                const m = data.metricas || { llamadas: 0, llamadasPct: 0, alumnos: 0, alumnosPct: 0 };
                html += `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-3 rounded border text-center"><div class="text-xl font-bold text-slate-700">${m.llamadas}</div><div class="text-xs text-slate-500">Llamadas</div></div>
                        <div class="bg-white p-3 rounded border-b-4 border-blue-500 text-center"><div class="text-xl font-bold text-blue-600">${m.llamadasPct}%</div><div class="text-xs text-slate-500">Cumplimiento</div></div>
                        <div class="bg-white p-3 rounded border text-center"><div class="text-xl font-bold text-slate-700">${m.alumnos}</div><div class="text-xs text-slate-500">Alumnos</div></div>
                        <div class="bg-white p-3 rounded border-b-4 border-orange-500 text-center"><div class="text-xl font-bold text-orange-600">${m.alumnosPct}%</div><div class="text-xs text-slate-500">Cumplimiento</div></div>
                    </div>
                `;

                // --- Calificaci√≥n General ---
                html += `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6 flex justify-between items-center">
                        <span class="text-lg font-bold text-gray-700">Calificaci√≥n Final</span>
                        <span class="text-3xl font-extrabold text-blue-600">${data.calificacionGeneral || '0.00'}</span>
                    </div>
                `;

                // --- Categor√≠as y Grupos ---
                template.forEach(cat => {
                    const catData = data.categoriasEvaluadas && data.categoriasEvaluadas[cat.nombre] ? data.categoriasEvaluadas[cat.nombre] : {};
                    const score = parseFloat(catData.puntaje || 0).toFixed(2);
                    
                    let groupsHtml = '';
                    cat.grupos.forEach(grupo => {
                        let criteriaList = '';
                        grupo.criterios.forEach(crit => {
                            const val = catData.criterios ? catData.criterios[crit] : '-';
                            criteriaList += `<li class="flex justify-between text-sm py-1 border-b border-gray-100 last:border-0"><span class="text-gray-600">${crit}</span><span class="font-bold">${val}</span></li>`;
                        });
                        
                        groupsHtml += `
                            <div class="mt-3 bg-slate-50 p-2 rounded border border-slate-200">
                                <div class="text-xs font-bold text-slate-600 uppercase mb-1">${grupo.nombre}</div>
                                <ul>${criteriaList}</ul>
                            </div>
                        `;
                    });

                    html += `
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-400 mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-gray-800">${cat.nombre}</h4>
                                <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">${score}</span>
                            </div>
                            <div class="text-sm text-gray-500 italic mb-2">
                                <p>üìù ${catData.comentarioCalidad || 'Sin comentarios'}</p>
                            </div>
                            ${groupsHtml}
                        </div>
                    `;
                });

                // --- Feedback General ---
                html += `
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mt-6">
                        <h5 class="font-bold text-yellow-800 text-sm mb-1">Feedback General</h5>
                        <p class="text-sm text-yellow-900">${data.comentariosGenerales || 'Sin comentarios.'}</p>
                    </div>
                `;

                content.innerHTML = html;

            } catch (error) {
                console.error("Error visualizando evaluaci√≥n:", error);
                content.innerHTML = `<div class="text-center p-4 text-red-500">Error al cargar datos.</div>`;
            }
        }

        // --- Helpers del √Årbol ---

        function toggleNode(supId) {
            const node = document.getElementById(`node-${supId}`);
            const icon = document.getElementById(`icon-${supId}`);
            node.classList.toggle('hidden');
            icon.classList.toggle('rotate-90');
        }

        function toggleTree(expand) {
            supervisorsCache.forEach(sup => {
                const node = document.getElementById(`node-${sup.id}`);
                const icon = document.getElementById(`icon-${sup.id}`);
                if (expand) {
                    node.classList.remove('hidden');
                    icon.classList.add('rotate-90');
                } else {
                    node.classList.add('hidden');
                    icon.classList.remove('rotate-90');
                }
            });
        }

        // Marcar/Desmarcar todos los asesores de un supervisor
        function toggleSupervisor(supId) {
            const parentCheck = document.getElementById(`check-${supId}`);
            const childChecks = document.querySelectorAll(`input[data-supervisor="${supId}"]`);
            
            childChecks.forEach(cb => cb.checked = parentCheck.checked);
            updateSelectionCount();
        }

        // Actualizar estado del checkbox padre seg√∫n los hijos
        function updateParentState(supId) {
            const parentCheck = document.getElementById(`check-${supId}`);
            const childChecks = Array.from(document.querySelectorAll(`input[data-supervisor="${supId}"]`));
            
            if (childChecks.length === 0) return;

            const allChecked = childChecks.every(cb => cb.checked);
            const someChecked = childChecks.some(cb => cb.checked);

            parentCheck.checked = allChecked;
            parentCheck.indeterminate = someChecked && !allChecked;
            
            updateSelectionCount();
        }

        function updateSelectionCount() {
            const count = document.querySelectorAll('.asesor-check:checked').length;
            document.getElementById('selectionCount').textContent = count;
        }

        // --- Motor de Exportaci√≥n ---

        async function generateCSVForSupervisor(supervisorId, asesorIds, filterMonth, filterYear) {
            const templateDoc = await getDoc(doc(db, "evaluation_templates", supervisorId));
            if (!templateDoc.exists()) return null;
            
            const template = normalizeCategories(templateDoc.data().categorias || []);
            const supervisorName = usersCache[supervisorId]?.nombre || supervisorId;

            // 1. Headers Din√°micos
            let headers = ["evalId", "asesorId", "asesorNombre", "mes", "a√±o", "calificacionGeneral", "metaLlamadas", "comentariosGenerales"];
            template.forEach(cat => {
                cat.grupos.forEach(grupo => {
                    grupo.criterios.forEach(crit => {
                        const cleanCrit = crit.replace(/"/g, '""');
                        headers.push(`"${cat.nombre} - ${grupo.nombre} - ${cleanCrit}"`);
                    });
                });
                headers.push(`"${cat.nombre}_Comentarios"`);
            });

            // 2. Query
            let q = query(collection(db, "evaluations"), where("supervisorId", "==", supervisorId));
            if (filterYear && filterYear !== 'all') {
                q = query(q, where("year", "==", filterYear));
            }
            
            const querySnapshot = await getDocs(q);
            let csvContent = headers.join(',') + '\n';
            let rowCount = 0;

            querySnapshot.forEach(doc => {
                const e = doc.data();
                
                // Filtros: Mes y Lista Espec√≠fica de Asesores
                if (filterMonth && filterMonth !== 'all' && e.month !== filterMonth) return;
                if (!asesorIds.includes(e.asesorId)) return; // <-- CLAVE: Solo exporta los seleccionados

                const asesorNombre = usersCache[e.asesorId]?.nombre || 'N/A';
                
                let row = [
                    doc.id, e.asesorId, `"${asesorNombre}"`, e.month, e.year,
                    e.calificacionGeneral || '', e.metaLlamadas || '',
                    `"${(e.comentariosGenerales || '').replace(/"/g, '""')}"`
                ];

                template.forEach(cat => {
                    const catData = e.categoriasEvaluadas ? e.categoriasEvaluadas[cat.nombre] || {} : {};
                    cat.grupos.forEach(grupo => {
                        grupo.criterios.forEach(crit => {
                            const score = catData.criterios ? catData.criterios[crit] || '' : '';
                            row.push(score);
                        });
                    });
                    const comments = `Calidad: ${catData.comentarioCalidad || ''} | Superv: ${catData.comentarioSupervision || ''}`;
                    row.push(`"${comments.replace(/"/g, '""')}"`);
                });
                
                csvContent += row.join(',') + '\n';
                rowCount++;
            });

            if (rowCount === 0) return null;

            return {
                fileName: `Evaluaciones_${supervisorName.replace(/\s+/g, '_')}_${filterYear === 'all' ? 'Completo' : filterYear}.csv`,
                content: csvContent
            };
        }

        // Manejo del Submit
        document.getElementById('massExportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Recolectar qu√© asesores se eligieron por cada supervisor
            const selectionMap = {}; // { 'supId': ['asesor1', 'asesor2'] }
            
            document.querySelectorAll('.asesor-check:checked').forEach(cb => {
                const supId = cb.dataset.supervisor;
                if (!selectionMap[supId]) selectionMap[supId] = [];
                selectionMap[supId].push(cb.value);
            });

            const supervisorsToProcess = Object.keys(selectionMap);
            
            if (supervisorsToProcess.length === 0) {
                alert("Por favor selecciona al menos un asesor.");
                return;
            }

            const btn = e.submitter;
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-t-transparent border-white rounded-full animate-spin mr-2"></div> Procesando...`;
            btn.disabled = true;

            const month = document.getElementById('massExportMonth').value;
            const year = document.getElementById('massExportYear').value;
            let filesGenerated = 0;

            try {
                for (const supId of supervisorsToProcess) {
                    const targetAsesores = selectionMap[supId];
                    const result = await generateCSVForSupervisor(supId, targetAsesores, month, year);
                    
                    if (result) {
                        downloadCSV(result.content, result.fileName);
                        filesGenerated++;
                        await new Promise(r => setTimeout(r, 800)); // Pausa para no saturar descargas
                    }
                }

                if (filesGenerated === 0) {
                    alert("No se encontraron evaluaciones con los filtros seleccionados.");
                } else {
                    document.getElementById('massExportModal').classList.add('hidden');
                }

            } catch (error) {
                console.error("Error exportaci√≥n masiva:", error);
                alert("Ocurri√≥ un error. Revisa la consola.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
        // ================= L√ìGICA DE CENTRO DE RESULTADOS (MULTI-SELECCI√ìN) =================
    
        let chartTrend = null;
        let chartStatus = null;
        let currentAnalyticsData = []; 
        let allDynamicCategories = new Set(); 
    
        // --- FUNCIONES DEL MULTI-SELECTOR DE SUPERVISORES ---
    
        function toggleSupDropdown() {
            const list = document.getElementById('supDropdownList');
            if(list) list.classList.toggle('hidden');
        }
    
        // Cerrar el men√∫ si se hace clic fuera
        window.addEventListener('click', function(e) {
            const btn = document.getElementById('supDropdownBtn');
            const list = document.getElementById('supDropdownList');
            if (btn && list && !btn.contains(e.target) && !list.contains(e.target)) {
                list.classList.add('hidden');
            }
        });
    
        function toggleAllSupervisors(source) {
            const checkboxes = document.querySelectorAll('.anl-sup-check');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateSupButtonText();
        }
    
        function updateSupButtonText() {
            const checkboxes = document.querySelectorAll('.anl-sup-check');
            const checked = document.querySelectorAll('.anl-sup-check:checked');
            const btnText = document.getElementById('supBtnText');
            const checkAll = document.getElementById('sup-check-all');
    
            // Actualizar estado del check "Todos"
            if (checkAll) {
                checkAll.checked = (checked.length === checkboxes.length && checkboxes.length > 0);
                checkAll.indeterminate = (checked.length > 0 && checked.length < checkboxes.length);
            }
    
            // Actualizar texto del bot√≥n
            if (checked.length === 0) {
                btnText.textContent = "Ninguno seleccionado";
            } else if (checked.length === checkboxes.length && checkboxes.length > 0) {
                btnText.textContent = "Todos seleccionados";
            } else if (checked.length === 1) {
                // Buscar el nombre del seleccionado en cach√©
                const supId = checked[0].value;
                const supName = supervisorsCache.find(s => s.id === supId)?.nombre || supId;
                btnText.textContent = supName;
            } else {
                btnText.textContent = `${checked.length} seleccionados`;
            }
        }
    
        // --- PESTA√ëAS ---
        function switchAnaTab(tabId) {
            ['t1', 't2', 't3'].forEach(t => {
                const view = document.getElementById(`view-${t}`);
                const btn = document.getElementById(`btn-${t}`);
                if(view) view.classList.add('hidden');
                if(btn) {
                    btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-white');
                    btn.classList.add('text-gray-500');
                }
            });
            const activeView = document.getElementById(`view-${tabId}`);
            const activeBtn = document.getElementById(`btn-${tabId}`);
            if(activeView) activeView.classList.remove('hidden');
            if(activeBtn) {
                activeBtn.classList.remove('text-gray-500');
                activeBtn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-white');
            }
        }
    
        // 1. Inicializaci√≥n
        function initAnalytics() {
            const ySel = document.getElementById('anlYear');
            const mSel = document.getElementById('anlMonth');
            const sContainer = document.getElementById('supCheckboxesContainer'); // Contenedor de checkboxes
            
            // Llenar A√±os y Meses
            if(ySel) ySel.innerHTML = availablePeriods.years.map(y => `<option value="${y}">${y}</option>`).join('');
            if(mSel) mSel.innerHTML = '<option value="all">Todos</option>' + availablePeriods.months.map(m => `<option value="${m}">${m}</option>`).join('');
            
            // Llenar Supervisores (GENERACI√ìN DE CHECKBOXES)
            if(sContainer) {
                sContainer.innerHTML = '';
                supervisorsCache.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center p-2 hover:bg-gray-50 rounded';
                    div.innerHTML = `
                        <input type="checkbox" id="sup-chk-${s.id}" value="${s.id}" checked onchange="updateSupButtonText()" class="anl-sup-check w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="sup-chk-${s.id}" class="ml-2 text-sm text-gray-700 w-full cursor-pointer">${s.nombre}</label>
                    `;
                    sContainer.appendChild(div);
                });
                updateSupButtonText(); // Actualizar texto inicial del bot√≥n
            }
    
            updateAnalytics(); // Carga inicial
        }
    
        // 2. Carga y Procesamiento
        async function updateAnalytics() {
            const yearElem = document.getElementById('anlYear');
            const monthElem = document.getElementById('anlMonth');
            
            if(!yearElem || !monthElem) return;
    
            const year = yearElem.value;
            const month = monthElem.value;
            
            // 1. OBTENER LISTA DE SUPERVISORES SELECCIONADOS
            const selectedSupChecks = document.querySelectorAll('.anl-sup-check:checked');
            const selectedSupIds = Array.from(selectedSupChecks).map(cb => cb.value);
    
            const btn = document.querySelector('button[onclick="updateAnalytics()"]');
            const oldTxt = btn ? btn.innerHTML : 'Analizar';
            if(btn) { btn.innerHTML = '...'; btn.disabled = true; }
    
            try {
                let q = query(collection(db, "evaluations"), where("year", "==", year));
                if (month !== 'all') q = query(q, where("month", "==", month));
                
                const snapshot = await getDocs(q);
                let rawEvals = [];
                allDynamicCategories.clear();
    
                snapshot.forEach(doc => {
                    const d = doc.data();
                    
                    // 2. FILTRO: Comprobar si el supervisor est√° en la lista de seleccionados
                    if (selectedSupIds.includes(d.supervisorId)) {
                        if (d.categoriasEvaluadas) {
                            Object.keys(d.categoriasEvaluadas).forEach(catName => allDynamicCategories.add(catName));
                        }
                        rawEvals.push(d);
                    }
                });
    
                currentAnalyticsData = rawEvals;
                renderCharts(rawEvals);
                renderTable1_Detail(rawEvals);
                renderTable2_Matrix(rawEvals);
                renderTable3_Supervisors(rawEvals);
    
            } catch (e) {
                console.error("Error en updateAnalytics:", e);
            } finally {
                if(btn) { btn.innerHTML = oldTxt; btn.disabled = false; }
            }
        }
    
        // 3. Gr√°ficas
        function renderCharts(data) {
            const ctxTrend = document.getElementById('trendChart');
            const ctxStatus = document.getElementById('statusChart');
            
            if (!ctxTrend || !ctxStatus) return;
    
            const months = availablePeriods.months;
            const monthAvgs = months.map(m => {
                const evalsInMonth = data.filter(d => d.month === m);
                if (evalsInMonth.length === 0) return null;
                const sum = evalsInMonth.reduce((acc, curr) => acc + (parseFloat(curr.calificacionGeneral)||0), 0);
                return (sum / evalsInMonth.length).toFixed(2);
            });
    
            if (chartTrend) chartTrend.destroy();
            chartTrend = new Chart(ctxTrend.getContext('2d'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Promedio Global (Selecci√≥n)',
                        data: monthAvgs,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.3, fill: true, spanGaps: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 10 } } }
            });
    
            let high = 0, mid = 0, low = 0;
            data.forEach(d => {
                const s = parseFloat(d.calificacionGeneral)||0;
                if(s >= 9) high++; else if(s >= 7) mid++; else low++;
            });
    
            if (chartStatus) chartStatus.destroy();
            chartStatus = new Chart(ctxStatus.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Excelente (9-10)', 'Regular (7-8)', 'Bajo (<7)'],
                    datasets: [{
                        data: [high, mid, low],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }
    
        // 4. Tablas
        function renderTable1_Detail(data) {
            const thead = document.getElementById('t1-head');
            const tbody = document.getElementById('t1-body');
            if(!thead || !tbody) return;
    
            const cats = Array.from(allDynamicCategories).sort();
            
            let headerHTML = `
                <tr>
                    <th class="px-4 py-3 text-left font-bold uppercase sticky left-0 bg-gray-100 cursor-pointer border-r z-20" onclick="sortTable1('name')">Asesor ‚Üï</th>
                    <th class="px-4 py-3 text-left font-bold uppercase">Usuario</th>
                    <th class="px-4 py-3 text-center font-bold uppercase">Mes</th>
            `;
            cats.forEach(c => headerHTML += `<th class="px-4 py-3 text-center font-bold uppercase text-xs text-blue-800 bg-blue-50">${c}</th>`);
            headerHTML += `<th class="px-4 py-3 text-center font-bold uppercase bg-gray-200 cursor-pointer" onclick="sortTable1('score')">Final ‚Üï</th></tr>`;
            
            thead.innerHTML = headerHTML;
            tbody.innerHTML = '';
            
            if(data.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">No hay datos disponibles con los filtros seleccionados.</td></tr>'; 
                return; 
            }
    
            data.forEach(d => {
                const u = usersCache[d.asesorId];
                const name = u ? u.nombre : d.asesorId;
                let rowHTML = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2 border-b font-medium sticky left-0 bg-white border-r">${name}</td>
                        <td class="px-4 py-2 border-b text-gray-500 text-xs">${d.asesorId}</td>
                        <td class="px-4 py-2 border-b text-center text-xs">${d.month}</td>
                `;
                cats.forEach(c => {
                    const catData = d.categoriasEvaluadas && d.categoriasEvaluadas[c];
                    const val = catData ? catData.puntaje : '-';
                    rowHTML += `<td class="px-4 py-2 border-b text-center text-xs text-gray-600">${val}</td>`;
                });
                const score = parseFloat(d.calificacionGeneral)||0;
                const color = score>=9?'text-green-600':score>=7?'text-yellow-600':'text-red-600';
                rowHTML += `<td class="px-4 py-2 border-b text-center font-bold ${color}">${score}</td></tr>`;
                tbody.innerHTML += rowHTML;
            });
        }
    
        function renderTable2_Matrix(data) {
            const tbody = document.getElementById('t2-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            const advisorMap = {};
    
            data.forEach(d => {
                if (!advisorMap[d.asesorId]) {
                    const u = usersCache[d.asesorId];
                    advisorMap[d.asesorId] = { name: u ? u.nombre : d.asesorId, months: {}, total: 0, count: 0 };
                }
                const s = parseFloat(d.calificacionGeneral)||0;
                advisorMap[d.asesorId].months[d.month] = s;
                advisorMap[d.asesorId].total += s;
                advisorMap[d.asesorId].count++;
            });
    
            Object.values(advisorMap).sort((a,b)=>a.name.localeCompare(b.name)).forEach(ad => {
                const avg = (ad.total/ad.count).toFixed(2);
                let cells = '';
                availablePeriods.months.forEach(m => {
                    const val = ad.months[m];
                    if (val !== undefined) {
                        const bg = val>=9?'bg-green-100 text-green-800':val>=7?'bg-yellow-100 text-yellow-800':'bg-red-100 text-red-800';
                        cells += `<td class="px-1 py-2 text-center text-xs font-bold ${bg} border border-white">${val.toFixed(1)}</td>`;
                    } else {
                        cells += `<td class="px-1 py-2 text-center text-xs text-gray-300 bg-gray-50 border border-white">-</td>`;
                    }
                });
                tbody.innerHTML += `<tr><td class="px-4 py-2 border-b font-medium text-xs sticky left-0 bg-white border-r">${ad.name}</td>${cells}<td class="px-4 py-2 font-bold text-center bg-gray-50 border-l">${avg}</td></tr>`;
            });
        }
    
        function renderTable3_Supervisors(data) {
            const tbody = document.getElementById('t3-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            const supMap = {};
    
            data.forEach(d => {
                if (!supMap[d.supervisorId]) supMap[d.supervisorId] = { id: d.supervisorId, total: 0, count: 0 };
                supMap[d.supervisorId].total += (parseFloat(d.calificacionGeneral)||0);
                supMap[d.supervisorId].count++;
            });
    
            Object.values(supMap).forEach(s => {
                const name = usersCache[s.id] ? usersCache[s.id].nombre : s.id;
                const avg = (s.total / s.count).toFixed(2);
                let badge = avg>=9?'<span class="bg-green-100 text-green-800 px-2 rounded-full text-xs">Excelente</span>':avg>=7?'<span class="bg-yellow-100 text-yellow-800 px-2 rounded-full text-xs">Regular</span>':'<span class="bg-red-100 text-red-800 px-2 rounded-full text-xs">Atenci√≥n</span>';
                
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 border-b font-medium">${name}</td>
                        <td class="px-6 py-4 border-b text-center">${s.count}</td>
                        <td class="px-6 py-4 border-b text-center font-bold text-lg">${avg}</td>
                        <td class="px-6 py-4 border-b text-center">${badge}</td>
                    </tr>`;
            });
        }
    
        // 5. CSV y Helpers
        function downloadWideCSV() {
            if (currentAnalyticsData.length === 0) return alert("No hay datos para exportar");
            const cats = Array.from(allDynamicCategories).sort();
            let csv = "Nombre Asesor,Usuario,Mes,A√±o,";
            cats.forEach(c => csv += `"${c} (Promedio)",`);
            csv += "Calificaci√≥n Final\n";
    
            currentAnalyticsData.forEach(d => {
                const u = usersCache[d.asesorId];
                const name = u ? u.nombre.replace(/"/g, '""') : d.asesorId;
                let row = `"${name}","${d.asesorId}",${d.month},${d.year},`;
                cats.forEach(c => {
                    const catData = d.categoriasEvaluadas && d.categoriasEvaluadas[c];
                    row += catData ? `${catData.puntaje},` : ",";
                });
                row += `${d.calificacionGeneral}\n`;
                csv += row;
            });
    
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Reporte_Resultados_${document.getElementById('anlYear').value}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    
        // Helpers de Ordenamiento (GLOBALES)
        window.sortTable1 = (key) => {
            const data = [...currentAnalyticsData];
            if (key === 'name') {
                data.sort((a,b) => {
                    const na = usersCache[a.asesorId]?.nombre || '';
                    const nb = usersCache[b.asesorId]?.nombre || '';
                    return na.localeCompare(nb);
                });
            } else if (key === 'score') {
                data.sort((a,b) => (parseFloat(b.calificacionGeneral)||0) - (parseFloat(a.calificacionGeneral)||0));
            }
            renderTable1_Detail(data);
        };
    
        window.sortSimpleTable = (tbodyId, colIndex) => {
            const tbody = document.getElementById(tbodyId);
            const rows = Array.from(tbody.rows);
            const isAsc = tbody.dataset.order === 'asc';
            rows.sort((a, b) => {
                const va = a.cells[colIndex].innerText;
                const vb = b.cells[colIndex].innerText;
                return isAsc ? va.localeCompare(vb, undefined, {numeric: true}) : vb.localeCompare(va, undefined, {numeric: true});
            });
            tbody.dataset.order = isAsc ? 'desc' : 'asc';
            rows.forEach(r => tbody.appendChild(r));
        };
        
        // ======================= EXPOSICI√ìN DE FUNCIONES GLOBALES =======================
        window.logout = logout;
        window.openUserModal = openUserModal;
        window.closeUserModal = closeUserModal;
        window.deleteUser = deleteUser;
        window.saveLoginTitles = saveLoginTitles;
        window.saveAvailablePeriods = saveAvailablePeriods;
        
        // --- AQU√ç ESTABAN FALTANDO LAS FUNCIONES NUEVAS DE GRUPOS ---
        window.openCategoryModal = openCategoryModal;
        window.closeCategoryModal = closeCategoryModal;
        window.addGroupBlock = addGroupBlock;             // <--- FALTABA ESTA
        window.addCriterionToGroup = addCriterionToGroup; // <--- FALTABA ESTA
        window.submitCategoryForm = submitCategoryForm;   // <--- FALTABA ESTA
        // ------------------------------------------------------------

        window.deleteCategory = deleteCategory;
        window.openEvaluationModal = openEvaluationModal;
        window.closeEvaluationModal = closeEvaluationModal;
        window.saveEvaluation = saveEvaluation;
        window.switchAsesorTab = switchAsesorTab;
        window.openAddAsesorModal = openAddAsesorModal; 
        window.closeAddAsesorModal = closeAddAsesorModal;
        window.toggleCriteria = toggleCriteria;
        window.openImportModal = openImportModal;
        window.closeImportModal = closeImportModal;
        window.exportUsersToCSV = exportUsersToCSV;
        window.exportSupervisorEvaluationsToCSV = exportSupervisorEvaluationsToCSV;
        window.loadSuperAdminCharts = loadSuperAdminCharts;
        window.loadSupervisorCharts = loadSupervisorCharts;
        window.calculateWeightedScore = calculateWeightedScore;
        window.sortUsers = sortUsers;
        window.changeUserPage = changeUserPage;
        // Insignias
        window.openBadgeModal = openBadgeModal;
        window.closeBadgeModal = closeBadgeModal;
        window.deleteBadge = deleteBadge;
        window.openGrantBadgeModal = openGrantBadgeModal;
        window.closeGrantBadgeModal = closeGrantBadgeModal;
        window.exportBadgesToCSV = exportBadgesToCSV;
        window.openMassExportModal = openMassExportModal;
        window.toggleNode = toggleNode;
        window.toggleTree = toggleTree;
        window.toggleSupervisor = toggleSupervisor;
        window.updateParentState = updateParentState;
        window.viewSingleEvaluationFromExport = viewSingleEvaluationFromExport;
        
        // Funciones del Centro de Resultados
        window.updateAnalytics = updateAnalytics;
        window.downloadWideCSV = downloadWideCSV;
        window.switchAnaTab = switchAnaTab;
        window.sortTable1 = sortTable1;
        window.sortSimpleTable = sortSimpleTable;

        // Funciones del Multiselector (A√ëADIR ESTAS L√çNEAS)
        window.toggleSupDropdown = toggleSupDropdown;
        window.toggleAllSupervisors = toggleAllSupervisors;
        window.updateSupButtonText = updateSupButtonText;

        window.loadTemplates = loadTemplates;
        window.openTemplateModal = openTemplateModal;
        window.deleteTemplate = deleteTemplate;
        window.setActiveTemplate = setActiveTemplate;
        
        // Sincronizaci√≥n Manual
        window.forceSyncToFirebase = async () => {
             showConfirmModal('Sincronizar a Firebase', 'Esto sobrescribir√° los datos en Firebase con los datos locales actuales. ¬øContinuar?', async () => {
                showSyncIndicator('superAdminSyncIndicator');
                try {
                    const batch = writeBatch(db);

                    Object.values(usersCache).forEach(user => {
                        const { id, ...userData } = user;
                        const userRef = doc(db, "users", id);
                        batch.set(userRef, userData);
                    });

                    Object.values(badgesCache).forEach(badge => {
                        const { id, ...badgeData } = badge;
                        const badgeRef = doc(db, "insignias", id);
                        batch.set(badgeRef, badgeData);
                    });
                    
                    await batch.commit();
                    alert('Sincronizaci√≥n completada exitosamente.');
                } catch (error) {
                    console.error("Error al forzar la sincronizaci√≥n:", error);
                    alert("Hubo un error durante la sincronizaci√≥n. Revisa la consola.");
                }
            });
        };
        window.forceReloadFromFirebase = async () => {
            showSyncIndicator('superAdminSyncIndicator');
            await loadUsersCache();
            await loadBadgesCache();
            await loadSuperAdminView();
            alert('Datos recargados desde Firebase.');
        };

        // --- FUNCI√ìN DE AUTO-CREACI√ìN DE ADMIN (SEMILLA) - VERSI√ìN ID PERSONALIZADO ---
        async function ensureAdminExists() {
            // CREDENCIALES
            const adminUser = "superadmin"; 
            const adminPass = "cnci2026";
            
            // 1. Verificar si ya existe el documento con ese ID exacto
            const docRef = doc(db, "users", adminUser); // Apuntamos directo al ID 'superadmin'
            const docSnap = await getDoc(docRef);

            // 2. Solo creamos si NO existe
            if (!docSnap.exists()) {
                console.log("‚ö†Ô∏è No se encontr√≥ Superadmin. Creando usuario inicial...");
                
                // USAMOS setDoc PARA FORZAR EL NOMBRE DEL DOCUMENTO
                await setDoc(doc(db, "users", adminUser), {
                    email: adminUser,      
                    password: adminPass,   
                    nombre: "Super Administrador",
                    rol: "superadmin", 
                    puesto: "Direcci√≥n",
                    createdAt: serverTimestamp()
                });
                
                console.log("‚úÖ Usuario creado exitosamente con ID: " + adminUser);
            } else {
                console.log("‚ÑπÔ∏è El usuario " + adminUser + " ya existe. No se hicieron cambios.");
            }
        }
    </script>
</body>
</html>
